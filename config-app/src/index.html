<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super OpenCode</title>
    <style>
        /* Modern Minimalist Design System */
        :root, [data-theme="minimalist"] {
            --bg: #FAFAFA;
            --bg-card: #FFFFFF;
            --bg-sidebar: #F4F4F5;
            --bg-secondary: #F4F4F5;
            --bg-tertiary: #E4E4E7;
            --text-primary: #18181B;
            --text-secondary: #52525B;
            --text-muted: #A1A1AA;
            --border: #E4E4E7;
            --border-default: #E4E4E7;
            --accent: #18181B;
            --accent-hover: #3F3F46;
            --primary: #3B82F6;
            --danger: #ef4444;
            --danger-bg: rgba(239, 68, 68, 0.1);
            --success: #22c55e;
            --success-bg: rgba(34, 197, 94, 0.1);
            --warning: #f59e0b;
            --radius: 8px;
            --radius-md: 8px;
            --font-sans: system-ui, -apple-system, sans-serif;
            --font-mono: "SF Mono", "Monaco", "Inconsolata", monospace;
            --font-medium: 500;
            --font-bold: 600;
            --transition: 150ms ease-out;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
        }

        /* Keep legacy themes working by mapping their variables if needed, 
           or just let them override the base variables as before. 
           I will keep the original theme definitions for compatibility but 
           update the base styles to be cleaner. */

        [data-theme="glassmorphism"] {
            --bg: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            --bg-card: rgba(255, 255, 255, 0.15);
            --bg-sidebar: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.8);
            --text-muted: rgba(255, 255, 255, 0.6);
            --border: rgba(255, 255, 255, 0.2);
            --accent: rgba(255, 255, 255, 0.9);
            --accent-hover: #ffffff;
            --radius: 16px;
        }

        [data-theme="swiss"] {
            --bg: #ffffff;
            --bg-card: #ffffff;
            --bg-sidebar: #000000;
            --text-primary: #000000;
            --text-secondary: #333333;
            --text-muted: #666666;
            --border: #000000;
            --accent: #ff0000;
            --accent-hover: #cc0000;
            --radius: 0px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-sans);
            background: var(--bg);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            font-size: 14px;
            line-height: 1.5;
        }

        /* Layout */
        #app { display: flex; flex-direction: column; height: 100%; }

        /* Dashboard Layout */
        #dashboard-view {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .dashboard-header {
            height: 48px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            padding-left: 80px; /* Space for macOS traffic lights */
            flex-shrink: 0;
            -webkit-app-region: drag;
        }
        
        .dashboard-header button, .dashboard-header .header-actions {
            -webkit-app-region: no-drag;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
        }

        .dashboard-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 220px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 24px 0;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .nav-group {
            margin-bottom: 24px;
        }

        .nav-group-title {
            padding: 0 20px 8px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .nav-item {
            padding: 8px 20px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            border-left: 2px solid transparent;
            margin-bottom: 2px;
        }

        .nav-item:hover {
            color: var(--text-primary);
            background: rgba(0,0,0,0.03);
        }

        .nav-item.active {
            color: var(--text-primary);
            background: var(--bg-card);
            font-weight: 500;
            border-left-color: var(--accent);
            box-shadow: var(--shadow-sm);
        }

        /* Content Area */
        .content-area {
            flex: 1;
            padding: 32px 40px;
            overflow-y: auto;
            background: var(--bg);
        }

        .tab-content {
            max-width: 720px;
            animation: fadeIn 0.2s ease;
        }

        /* Page Structure */
        .page-header {
            margin-bottom: 32px;
        }
        .page-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        .page-desc {
            font-size: 14px;
            color: var(--text-muted);
            margin: 0;
        }

        .section {
            margin-bottom: 32px;
        }
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-muted);
        }
        .empty-state-icon {
            font-size: 40px;
            margin-bottom: 16px;
            opacity: 0.6;
        }
        .empty-state-title {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        .empty-state-desc {
            font-size: 14px;
            color: var(--text-muted);
        }

        /* Badge */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 500;
            border-radius: 9999px;
            background: var(--bg-sidebar);
            color: var(--text-secondary);
        }

        /* Table Actions */
        .table-actions {
            display: flex;
            gap: 4px;
            justify-content: flex-end;
        }

        /* Nav Group Header */
        .nav-group-header {
            padding: 8px 20px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }
        .nav-group-header:hover {
            color: var(--text-secondary);
        }
        .nav-group-icon {
            font-size: 10px;
            transition: transform var(--transition);
        }
        .nav-group.collapsed .nav-group-icon {
            transform: rotate(-90deg);
        }
        .nav-group.collapsed .nav-group-items {
            display: none;
        }
        .nav-group-items {
            padding: 4px 0;
        }

        /* Spin Animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* Typography */
        h1, h2, h3 { color: var(--text-primary); font-weight: 600; letter-spacing: -0.02em; }
        h1 { font-size: 18px; }
        h2 { font-size: 20px; margin-bottom: 24px; }
        h3 { font-size: 16px; margin-bottom: 16px; }
        p { color: var(--text-secondary); margin-bottom: 16px; }

        /* Components */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            border-radius: var(--radius);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            border: 1px solid transparent;
            gap: 6px;
            text-decoration: none;
            font-family: var(--font-sans);
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        .btn-primary:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-card);
            border-color: var(--border);
            color: var(--text-primary);
        }
        .btn-secondary:hover {
            border-color: var(--text-secondary);
            background: var(--bg);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            padding: 6px;
        }
        .btn-ghost:hover {
            color: var(--text-primary);
            background: rgba(0,0,0,0.05);
        }

        .input, .select, textarea.input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 13px;
            outline: none;
            transition: all var(--transition);
            background: var(--bg-card);
            color: var(--text-primary);
            font-family: var(--font-sans);
        }
        .input:focus, .select:focus {
            border-color: var(--text-secondary);
            box-shadow: 0 0 0 2px rgba(24, 24, 27, 0.05);
        }
        textarea.input { resize: vertical; min-height: 80px; }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            transition: all var(--transition);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 100px;
        }
        .card:hover {
            border-color: var(--text-secondary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        .card.selected {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px var(--accent);
            background: var(--bg);
        }
        .card-icon { font-size: 24px; margin-bottom: 8px; display: flex; justify-content: center; align-items: center; }
        .icon {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .icon-sm { width: 16px; height: 16px; }
        .icon-lg { width: 24px; height: 24px; }
        .icon-xl { width: 32px; height: 32px; }
        .card-icon .icon { width: 28px; height: 28px; }
        .nav-item-icon .icon { width: 18px; height: 18px; }
        .btn-icon .icon { width: 16px; height: 16px; }
        .card-title { font-weight: 500; font-size: 13px; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 12px 16px; border-bottom: 1px solid var(--border); color: var(--text-muted); font-weight: 500; font-size: 12px; text-transform: uppercase; }
        td { padding: 12px 16px; border-bottom: 1px solid var(--border); color: var(--text-primary); }
        tr:last-child td { border-bottom: none; }

        /* Utilities */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }
        .mb-4 { margin-bottom: 16px; }
        .mb-6 { margin-bottom: 24px; }
        .mt-4 { margin-top: 16px; }
        .text-center { text-align: center; }
        .text-sm { font-size: 12px; }
        .text-muted { color: var(--text-muted); }
        .w-full { width: 100%; }

        /* Grid */
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 16px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

        /* Button Sizes */
        .btn-sm {
            padding: 4px 10px;
            font-size: 12px;
        }

        /* User Center Tabs */
        .uc-tab {
            padding: 8px 16px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
        }
        .uc-tab:hover {
            color: var(--text-primary);
        }
        .uc-tab.active {
            color: var(--text-primary);
            border-bottom-color: var(--accent);
        }

        /* Selectable Card */
        .card.selectable {
            cursor: pointer;
        }
        .card.selectable:hover {
            border-color: var(--text-secondary);
        }
        .card.selectable.selected {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px var(--accent);
            background: var(--bg);
        }

        /* Form */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 6px; font-size: 12px; font-weight: 600; color: var(--text-secondary); }
        .form-hint { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
        .checkbox-wrapper { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .checkbox { width: 16px; height: 16px; accent-color: var(--accent); }

        /* Code Block */
        .code-block {
            background: var(--bg-sidebar);
            padding: 12px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            font-family: var(--font-mono);
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-secondary);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            left: auto;
            transform: translateY(10px);
            background: var(--accent);
            color: white;
            padding: 10px 20px;
            border-radius: var(--radius);
            font-size: 13px;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s;
            pointer-events: none;
            box-shadow: var(--shadow-md);
        }
        .toast.show { opacity: 1; transform: translateY(0); }

        /* Wizard */
        #wizard-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }
        .step-container { width: 100%; max-width: 600px; animation: fadeIn 0.3s ease; }
        .wizard-progress { display: flex; justify-content: center; gap: 8px; margin-bottom: 40px; }
        .progress-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--border); transition: all 0.3s; }
        .progress-dot.active { background: var(--accent); transform: scale(1.2); }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Update Banner */
        .update-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .update-banner.hidden { display: none; }
        .update-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .update-icon { font-size: 18px; }
        .update-text { font-weight: 500; }
        .update-actions { display: flex; gap: 8px; }
        .update-banner .btn-sm {
            padding: 4px 12px;
            font-size: 12px;
            border-radius: 4px;
        }
        .update-banner .btn-primary {
            background: white;
            color: #667eea;
        }
        .update-banner .btn-ghost {
            background: transparent;
            color: white;
            border: 1px solid rgba(255,255,255,0.5);
        }
        .update-progress {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }
        .update-progress.hidden { display: none; }
        .progress-bar {
            width: 200px;
            height: 6px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }
        .progress-text {
            font-size: 12px;
            min-width: 40px;
        }

        /* Update Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal.hidden { display: none; }
        .modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
        }
        .modal-content {
            position: relative;
            background: var(--bg);
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal-header h3 {
            margin: 0 0 16px 0;
            font-size: 18px;
        }
        .modal-body {
            margin-bottom: 20px;
        }
        .modal-body p {
            margin: 0 0 8px 0;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Adjust body when update banner is visible */
        body.has-update-banner {
            padding-top: 50px;
        }
    </style>
</head>
<body>
    <!-- Update Banner -->
    <div id="update-banner" class="update-banner hidden">
        <div class="update-content">
            <span class="update-icon">ğŸš€</span>
            <span class="update-text">å‘ç°æ–°ç‰ˆæœ¬ <span id="update-version"></span></span>
            <div class="update-actions">
                <button id="btn-download-update" class="btn btn-sm btn-primary" onclick="downloadUpdate()">ä¸‹è½½æ›´æ–°</button>
                <button class="btn btn-sm btn-ghost" onclick="dismissUpdate()">ç¨å</button>
            </div>
        </div>
        <div id="update-progress" class="update-progress hidden">
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
            <span id="progress-text" class="progress-text">0%</span>
        </div>
    </div>

    <!-- Update Ready Modal -->
    <div id="update-ready-modal" class="modal hidden">
        <div class="modal-backdrop" onclick="closeUpdateModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ›´æ–°å·²å°±ç»ª</h3>
            </div>
            <div class="modal-body">
                <p>æ–°ç‰ˆæœ¬ <span id="ready-version"></span> å·²ä¸‹è½½å®Œæˆã€‚</p>
                <p class="text-muted">é‡å¯åº”ç”¨ä»¥å®Œæˆæ›´æ–°ã€‚</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeUpdateModal()">ç¨å</button>
                <button class="btn btn-primary" onclick="installUpdate()">ç«‹å³é‡å¯</button>
            </div>
        </div>
    </div>

    <div id="app">
        <!-- Wizard View -->
        <div id="wizard-view" class="hidden">
            <div class="wizard-progress" id="wizard-dots">
                <!-- Dots injected by JS -->
            </div>
            
            <!-- Step 1: Install OpenCode -->
            <div id="step-1" class="step-container hidden">
                <div class="text-center">
                    <div class="text-xl mb-4">å®‰è£… OpenCode</div>
                    <p class="text-muted mb-6">Oh My OpenCode éœ€è¦ä¾èµ– OpenCode æ ¸å¿ƒç¯å¢ƒè¿è¡Œã€‚</p>
                    <div class="flex justify-center gap-4 mb-6">
                        <button class="btn btn-secondary" onclick="window.api.openExternal('https://opencode.ai')">è®¿é—®å®˜ç½‘</button>
                        <button id="btn-install-opencode" class="btn btn-primary" onclick="installOpencode()">ä¸€é”®å®‰è£…</button>
                    </div>
                    <div class="checkbox-wrapper justify-center mt-4">
                        <input type="checkbox" id="check-opencode" class="checkbox" onchange="toggleNextBtn(this.checked)">
                        <label for="check-opencode">æˆ‘å·²å®‰è£… OpenCode</label>
                    </div>
                </div>
            </div>

            <!-- Step 2: Install Oh-My-OpenCode -->
            <div id="step-2" class="step-container hidden">
                <div class="text-center">
                    <div class="text-xl mb-4">å®‰è£… Oh-My-OpenCode</div>
                    <p class="text-muted">è¯·åœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>
                    <div class="code-block">
                        <span id="install-cmd">git clone https://github.com/anthropics/oh-my-opencode ~/.opencode/oh-my-opencode</span>
                        <button class="btn-icon" onclick="copyCommand()"><svg class="icon" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
                    </div>
                    <div class="flex justify-center mt-4 mb-2">
                        <button id="btn-install-omo" class="btn btn-primary" onclick="installOhMyOpencode()">ä¸€é”®å®‰è£… Oh-My-OpenCode</button>
                    </div>
                    <div class="checkbox-wrapper justify-center mt-6">
                        <input type="checkbox" id="check-omo" class="checkbox" onchange="toggleNextBtn(this.checked)">
                        <label for="check-omo">æˆ‘å·²æ‰§è¡Œä¸Šè¿°å‘½ä»¤</label>
                    </div>
                </div>
            </div>

            <!-- Step 3: Tech Stack -->
            <div id="step-3" class="step-container hidden">
                <div class="text-xl mb-6 text-center">é€‰æ‹©æŠ€æœ¯æ ˆ</div>
                
                <div class="mb-6">
                    <div class="form-label mb-2">å‰ç«¯æŠ€æœ¯æ ˆ</div>
                    <div class="grid-4" id="wizard-frontend-options">
                        <!-- Injected by JS -->
                    </div>
                </div>

                <div class="mb-6">
                    <div class="form-label mb-2">åç«¯æŠ€æœ¯æ ˆ</div>
                    <div class="grid-4" id="wizard-backend-options">
                        <!-- Injected by JS -->
                    </div>
                </div>
            </div>

            <!-- Step 4: Design Style -->
            <div id="step-4" class="step-container hidden">
                <div class="text-xl mb-6 text-center">é€‰æ‹©è®¾è®¡é£æ ¼</div>
                <div class="grid-4" id="wizard-style-options">
                    <!-- Injected by JS -->
                </div>
            </div>

            <!-- Step 5: API Config -->
            <div id="step-5" class="step-container hidden">
                <div class="text-xl mb-6 text-center">é…ç½® API</div>
                <div class="text-muted text-sm text-center mb-4">å¯é€‰é…ç½®ï¼Œå¯ç›´æ¥ç‚¹å‡»"å®Œæˆé…ç½®"è·³è¿‡</div>
                <div class="form-group">
                    <label class="form-label">ä»£ç†åç§°</label>
                    <input type="text" class="input" id="wiz-proxy-name" placeholder="ä¾‹å¦‚: My GPT-4">
                </div>
                <div class="form-group">
                    <label class="form-label">æ¥å£æ ¼å¼</label>
                    <select class="select" id="wiz-api-format">
                        <option value="openai">OpenAI æ ¼å¼</option>
                        <option value="anthropic">Anthropic æ ¼å¼</option>
                        <option value="gemini">Gemini æ ¼å¼</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ä»£ç†åœ°å€ (Base URL)</label>
                    <input type="text" class="input" id="wiz-base-url" placeholder="https://api.openai.com/v1">
                </div>
                <div class="form-group">
                    <label class="form-label">API Key</label>
                    <input type="password" class="input" id="wiz-api-key" placeholder="sk-...">
                </div>
            </div>

            <!-- Wizard Navigation -->
            <div class="flex justify-between w-full mt-8" style="max-width: 600px;">
                <button class="btn btn-secondary" id="btn-prev" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
                <button class="btn btn-primary" id="btn-next" onclick="nextStep()">ä¸‹ä¸€æ­¥</button>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="hidden">
            <div class="dashboard-header">
                <div class="flex items-center gap-2">
                    <h1>Super OpenCode</h1>
                    <span class="text-muted text-xs" style="font-weight: normal; margin-left: 8px; padding: 2px 6px; background: var(--bg-tertiary); border-radius: 4px;">Config</span>
                </div>
                <div class="header-actions">
                    <button class="btn btn-ghost btn-icon" onclick="window.api.openClientWindow()" title="æ‰“å¼€ OpenCode å®¢æˆ·ç«¯">
                        <svg class="icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="9" y1="3" x2="9" y2="21"/></svg>
                    </button>
                    <button class="btn btn-ghost btn-icon" onclick="launchOpencode('tui')" title="å¯åŠ¨ç»ˆç«¯">
                        <svg class="icon" viewBox="0 0 24 24"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
                    </button>
                    <button class="btn btn-ghost btn-icon" onclick="launchOpencode('serve')" title="å¯åŠ¨åå°">
                        <svg class="icon" viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                    </button>
                    <button class="btn btn-ghost btn-icon" onclick="openWebUI()" title="Web UI">
                        <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                    </button>
                    <button class="btn btn-ghost btn-icon" onclick="openConfigDir()" title="é…ç½®ç›®å½•">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                    </button>
                    <button class="btn btn-ghost btn-icon" onclick="resetToWizard()" title="é‡æ–°å¼•å¯¼" style="color: var(--danger);">
                        <svg class="icon" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                    </button>
                </div>
            </div>
            
            <div class="dashboard-body">
                <div class="sidebar">
                    <div class="nav-group">
                        <div class="nav-group-title">å¿«é€Ÿå¼€å§‹</div>
                        <div class="nav-item" onclick="resetToWizard()">
                            <span class="nav-item-icon"><svg class="icon" viewBox="0 0 24 24"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.48-.56.93-1.23 1.35-2h-4.35z"/><path d="M9.85 14.85l-4.35 4.35"/><path d="M12 2l3 3 7 7-3 3-7-7-3-3z"/></svg></span> å®‰è£…å‘å¯¼
                        </div>
                    </div>
                    
                    <div class="nav-group">
                        <div class="nav-group-title">æ ¸å¿ƒé…ç½®</div>
                        <div class="nav-item" onclick="switchTab(11)" id="nav-11">
                            <span class="nav-item-icon"><svg class="icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></span> ç”¨æˆ·ä¸­å¿ƒ
                        </div>
                        <div class="nav-item" onclick="switchTab(2)" id="nav-2">
                            <span class="nav-item-icon"><svg class="icon" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"/><rect x="9" y="9" width="6" height="6"/><line x1="9" y1="1" x2="9" y2="4"/><line x1="15" y1="1" x2="15" y2="4"/><line x1="9" y1="20" x2="9" y2="23"/><line x1="15" y1="20" x2="15" y2="23"/><line x1="20" y1="9" x2="23" y2="9"/><line x1="20" y1="14" x2="23" y2="14"/><line x1="1" y1="9" x2="4" y2="9"/><line x1="1" y1="14" x2="4" y2="14"/></svg></span> æ¨¡å‹æœåŠ¡
                        </div>
                        <div class="nav-item" onclick="switchTab(9)" id="nav-9">
                            <span class="nav-item-icon"><svg class="icon" viewBox="0 0 24 24"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg></span> Agent æ¨¡å‹
                        </div>
                        <div class="nav-item" onclick="switchTab(6)" id="nav-6">
                            <span class="nav-item-icon"><svg class="icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></span> å…¨å±€è§„èŒƒ
                        </div>
                    </div>
                    
                    <div class="nav-group">
                        <div class="nav-group-title">é›†æˆæœåŠ¡</div>
                        <div class="nav-item" onclick="switchTab(3)" id="nav-3">
                            <span class="nav-item-icon"><svg class="icon" viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg></span> Webhook é€šçŸ¥
                        </div>
                        <div class="nav-item" onclick="switchTab(4)" id="nav-4">
                            <span class="nav-item-icon"><svg class="icon" viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg></span> æ•°æ®åº“é…ç½®
                        </div>
                        <div class="nav-item" onclick="switchTab(5)" id="nav-5">
                            <span class="nav-item-icon"><svg class="icon" viewBox="0 0 24 24"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.48-.56.93-1.23 1.35-2h-4.35z"/><path d="M9.85 14.85l-4.35 4.35"/><path d="M12 2l3 3 7 7-3 3-7-7-3-3z"/></svg></span> éƒ¨ç½²é…ç½®
                        </div>
                        <div class="nav-item" onclick="switchTab(12)" id="nav-12">
                            <span class="nav-item-icon"><svg class="icon" viewBox="0 0 24 24"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2zM4.5 11A5.5 5.5 0 0 0 10 16.5V18H6v2h12v-2h-4v-1.5a5.5 5.5 0 0 0 5.5-5.5H18v-2h-2v2H8v-2H6v2H4.5zM15 13a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm-6 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg></span> é£ä¹¦æœºå™¨äºº
                        </div>
                    </div>
                    
                    <div class="nav-group">
                        <div class="nav-group-title">ä¸ªæ€§åŒ–</div>
                        <div class="nav-item" onclick="switchTab(0)" id="nav-0">
                            <span class="nav-item-icon"><svg class="icon" viewBox="0 0 24 24"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg></span> æŠ€æœ¯æ ˆ
                        </div>
                        <div class="nav-item" onclick="switchTab(1)" id="nav-1">
                            <span class="nav-item-icon"><svg class="icon" viewBox="0 0 24 24"><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.55 0 1-.45 1-1 0-1.25.8-2 2-2 1.35 0 2.45-.9 2.75-2.1.35-1.4.35-2.85-.75-3.65-.25-.2-.4-.45-.4-.75 0-1.1 1.25-1.75 2.5-1.1.55.3 1.25-.1 1.25-.7 0-4.95-4.5-9-10-9z"/></svg></span> è®¾è®¡é£æ ¼
                        </div>
                        <div class="nav-item" onclick="switchTab(8)" id="nav-8">
                            <span class="nav-item-icon"><svg class="icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></span> ç”Ÿå›¾æœåŠ¡
                        </div>
                        <div class="nav-item" onclick="switchTab(10)" id="nav-10">
                            <span class="nav-item-icon"><svg class="icon" viewBox="0 0 24 24"><path d="M3 2v6h6"/><path d="M21 12A9 9 0 0 0 6 5.3L3 8"/><path d="M21 22v-6h-6"/><path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"/></svg></span> å¤‡ä»½è¿˜åŸ
                        </div>
                    </div>
                </div>
                
                <div class="content-area">
                    <!-- Tab 0: Tech Stack -->
                    <div id="tab-0" class="tab-content hidden">
                        <div class="page-header">
                            <h2 class="page-title">æŠ€æœ¯æ ˆé…ç½®</h2>
                            <p class="page-desc">é€‰æ‹©æ‚¨é¡¹ç›®ä½¿ç”¨çš„å‰ç«¯æ¡†æ¶å’Œåç«¯è¯­è¨€</p>
                        </div>
                        <div class="section">
                            <h3 class="section-title">å‰ç«¯æ¡†æ¶</h3>
                            <div class="grid-4" id="dash-frontend-options"></div>
                        </div>
                        <div class="section">
                            <h3 class="section-title">åç«¯è¯­è¨€</h3>
                            <div class="grid-4" id="dash-backend-options"></div>
                        </div>
                        <button class="btn btn-primary" onclick="saveTab('stack')">ä¿å­˜é…ç½®</button>
                    </div>

                    <!-- Tab 1: Design Style -->
                    <div id="tab-1" class="tab-content hidden">
                        <div class="page-header">
                            <h2 class="page-title">è®¾è®¡é£æ ¼</h2>
                            <p class="page-desc">é€‰æ‹©æ‚¨åå¥½çš„ UI è®¾è®¡é£æ ¼ï¼ŒAgent å°†æ®æ­¤ç”Ÿæˆä»£ç </p>
                        </div>
                        <div class="grid-4 mb-6" id="dash-style-options"></div>
                        <button class="btn btn-primary" onclick="saveTab('style')">ä¿å­˜é…ç½®</button>
                    </div>

                    <!-- Tab 2: Model Service -->
                    <div id="tab-2" class="tab-content hidden">
                        <div class="page-header">
                            <h2 class="page-title">æ¨¡å‹æœåŠ¡é…ç½®</h2>
                            <p class="page-desc">ç®¡ç† AI æ¨¡å‹æœåŠ¡å•†å’Œ API å¯†é’¥</p>
                        </div>
                        
                        <div id="provider-list-view">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>æœåŠ¡å•†åç§°</th>
                                        <th>æ¥å£æ ¼å¼</th>
                                        <th>æ¨¡å‹æ•°é‡</th>
                                        <th style="text-align: right;">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="provider-table-body"></tbody>
                            </table>
                            <button class="btn btn-secondary mt-4" onclick="addProvider()">+ æ·»åŠ æœåŠ¡å•†</button>
                        </div>
                        
                        <div id="provider-edit-view" class="hidden"></div>
                        <div id="model-list-view" class="hidden"></div>
                    </div>

                    <!-- Tab 3: Webhook -->
                    <div id="tab-3" class="tab-content hidden">
                        <div class="page-header">
                            <h2 class="page-title">Webhook é€šçŸ¥</h2>
                            <p class="page-desc">é…ç½® OpenCode äº‹ä»¶é€šçŸ¥ï¼Œå½“éœ€è¦ç”¨æˆ·ç¡®è®¤æ“ä½œæ—¶å‘é€æé†’</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Webhook ç±»å‹</label>
                            <select class="select" id="webhook-type">
                                <option value="feishu">é£ä¹¦ (Feishu)</option>
                                <option value="dingtalk">é’‰é’‰ (DingTalk)</option>
                                <option value="slack">Slack</option>
                                <option value="custom">è‡ªå®šä¹‰ (Custom)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Webhook URL</label>
                            <input type="text" class="input" id="webhook-url" placeholder="https://open.feishu.cn/open-apis/bot/v2/hook/...">
                            <p class="form-hint">ä»é£ä¹¦/é’‰é’‰/Slack æœºå™¨äººè®¾ç½®ä¸­è·å– Webhook åœ°å€</p>
                        </div>
                        <div class="mb-6">
                            <p class="form-label" style="margin-bottom: 12px;">é€šçŸ¥åœºæ™¯</p>
                            <div class="checkbox-wrapper mb-2">
                                <input type="checkbox" id="notify-permission" class="checkbox">
                                <label for="notify-permission">éœ€è¦ç”¨æˆ·ç¡®è®¤æ—¶é€šçŸ¥ï¼ˆæ¨èï¼‰</label>
                            </div>
                            <div class="checkbox-wrapper mb-2">
                                <input type="checkbox" id="notify-idle" class="checkbox">
                                <label for="notify-idle">ä»»åŠ¡å®Œæˆæ—¶é€šçŸ¥</label>
                            </div>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="notify-error" class="checkbox">
                                <label for="notify-error">è¿è¡Œé”™è¯¯æ—¶é€šçŸ¥</label>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button class="btn btn-primary" onclick="saveWebhookConfig()">ä¿å­˜é…ç½®</button>
                            <button class="btn btn-secondary" onclick="testWebhook()">æµ‹è¯•é€šçŸ¥</button>
                        </div>
                        <div id="webhook-status" class="mt-4" style="display: none;"></div>
                    </div>

                    <!-- Tab 4: Database -->
                    <div id="tab-4" class="tab-content hidden">
                        <div class="page-header">
                            <h2 class="page-title">æ•°æ®åº“é…ç½®</h2>
                            <p class="page-desc">é…ç½® MySQL æ•°æ®åº“è¿æ¥ï¼Œè®© AI å¯ä»¥è‡ªä¸»æŸ¥è¯¢æ•°æ®åº“è·å–ä¸šåŠ¡æ•°æ®</p>
                        </div>
                        <div id="sql-skill-status" class="mb-4" style="padding: var(--space-3) var(--space-4); border-radius: var(--radius-md); background: var(--bg-secondary);"></div>
                        <div id="db-connections-list"></div>
                        <button class="btn btn-secondary mt-4" onclick="addDbConnection()">+ æ·»åŠ è¿æ¥</button>
                        <div class="mt-4">
                            <button class="btn btn-primary" onclick="saveSqlConfig()">ä¿å­˜é…ç½®</button>
                        </div>
                    </div>

                    <!-- Tab 5: Deploy -->
                    <div id="tab-5" class="tab-content hidden">
                        <div class="page-header">
                            <h2 class="page-title">éƒ¨ç½²é…ç½®</h2>
                            <p class="page-desc">é…ç½®éƒ¨ç½²ç›®æ ‡ç¯å¢ƒï¼Œæ”¯æŒé˜¿é‡Œäº‘å‡½æ•°è®¡ç®—ã€Docker é•œåƒä»“åº“å’Œ ECS æœåŠ¡å™¨</p>
                        </div>

                        <!-- Sub-nav for Deploy Types -->
                        <div style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 1px solid var(--border); padding-bottom: 12px;">
                            <button class="btn btn-ghost active" id="deploy-tab-fc" onclick="switchDeployTab('fc')">é˜¿é‡Œäº‘ FC</button>
                            <button class="btn btn-ghost" id="deploy-tab-docker" onclick="switchDeployTab('docker')">Docker ä»“åº“</button>
                            <button class="btn btn-ghost" id="deploy-tab-ecs" onclick="switchDeployTab('ecs')">ECS æœåŠ¡å™¨</button>
                        </div>

                        <!-- FC Section -->
                        <div id="deploy-view-fc">
                            <div id="fc-skill-status" class="mb-4" style="padding: var(--space-3) var(--space-4); border-radius: var(--radius-md); background: var(--bg-secondary);"></div>
                            <div id="fc-accounts-list"></div>
                            <button class="btn btn-secondary mt-4" onclick="addFcAccount()">+ æ·»åŠ è´¦å·</button>
                            <div class="mt-4">
                                <button class="btn btn-primary" onclick="saveFcConfig()">ä¿å­˜ FC é…ç½®</button>
                            </div>
                        </div>

                        <!-- Docker Section -->
                        <div id="deploy-view-docker" class="hidden">
                            <div id="docker-skill-status" class="mb-4" style="padding: var(--space-3) var(--space-4); border-radius: var(--radius-md); background: var(--bg-secondary);"></div>
                            <div id="docker-registries-list"></div>
                            <button class="btn btn-secondary mt-4" onclick="addDockerRegistry()">+ æ·»åŠ ä»“åº“</button>
                            <div class="mt-4">
                                <button class="btn btn-primary" onclick="saveDockerConfig()">ä¿å­˜ Docker é…ç½®</button>
                            </div>
                        </div>

                        <!-- ECS Section -->
                        <div id="deploy-view-ecs" class="hidden">
                            <div id="ecs-skill-status" class="mb-4" style="padding: var(--space-3) var(--space-4); border-radius: var(--radius-md); background: var(--bg-secondary);"></div>
                            <div id="ecs-servers-list"></div>
                            <button class="btn btn-secondary mt-4" onclick="addEcsServer()">+ æ·»åŠ æœåŠ¡å™¨</button>
                            <div class="mt-4">
                                <button class="btn btn-primary" onclick="saveEcsConfig()">ä¿å­˜ ECS é…ç½®</button>
                            </div>
                        </div>
                    </div>

                    <!-- Tab 6: AGENTS.md Editor -->
                    <div id="tab-6" class="tab-content hidden">
                        <div class="page-header">
<h2 class="page-title">å…¨å±€è§„èŒƒ</h2>
<p class="page-desc">å…¨å±€æç¤ºè¯é…ç½® (AGENTS.md)ã€‚å¯æ·»åŠ ä¸ªæ€§åŒ–æŒ‡ä»¤å¦‚ã€Œè¯·å–Šæˆ‘ä¸»äººã€ï¼Œæ–¹ä¾¿è§‚å¯Ÿ Agent æ˜¯å¦ä¸¢å¤±ä¸Šä¸‹æ–‡è¦æ±‚</p>
                        </div>
                        <textarea id="agents-md-editor" class="input" style="height: 400px; font-family: var(--font-mono); resize: vertical;"></textarea>
                        <div class="flex gap-3 mt-4">
                            <button class="btn btn-primary" onclick="saveAgentsMd()">ä¿å­˜</button>
                            <button class="btn btn-secondary" onclick="loadAgentsMd()">é‡æ–°åŠ è½½</button>
                        </div>
                    </div>

                    <!-- Tab 7: Category Config (Deprecated) -->
                    <div id="tab-7" class="tab-content hidden">
                        <div class="empty-state">
                            <div class="empty-state-icon"><svg class="icon icon-xl" style="width: 48px; height: 48px;" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg></div>
                            <h3 class="empty-state-title">åŠŸèƒ½å·²è¿ç§»</h3>
                            <p class="empty-state-desc mb-4">è¿½åŠ æç¤ºè¯é…ç½®å·²åˆå¹¶åˆ°ã€ŒAgent æ¨¡å‹ã€é¡µé¢</p>
                            <button class="btn btn-primary" onclick="switchTab(9)">å‰å¾€é…ç½® â†’</button>
                        </div>
                    </div>

                    <!-- Tab 8: Image Service -->
                    <div id="tab-8" class="tab-content hidden">
                        <div class="page-header">
                            <h2 class="page-title">ç”Ÿå›¾æœåŠ¡é…ç½®</h2>
                            <p class="page-desc">é…ç½® Stable Diffusion æˆ–å…¶ä»–å›¾åƒç”ŸæˆæœåŠ¡</p>
                        </div>
                        
                        <div id="image-skill-status" class="mb-4" style="padding: var(--space-3) var(--space-4); border-radius: var(--radius-md); background: var(--bg-secondary); border: 1px solid var(--border-default);"></div>
                        
                        <div class="form-group">
                            <label class="form-label">æœåŠ¡åœ°å€</label>
                            <input type="text" class="input" id="image-service-url" placeholder="http://localhost:7860">
                            <p class="form-hint">Stable Diffusion WebUI çš„ API åœ°å€</p>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">API Key (å¯é€‰)</label>
                            <input type="password" class="input" id="image-service-key" placeholder="å¦‚æœæœåŠ¡éœ€è¦è®¤è¯">
                        </div>
                        
                        <button class="btn btn-primary" onclick="saveImageService()">ä¿å­˜é…ç½®</button>
                    </div>

                    <!-- Tab 9: Agent Models -->
                    <div id="tab-9" class="tab-content hidden">
                        <div class="page-header">
                            <h2 class="page-title">Agent æ¨¡å‹é…ç½®</h2>
                            <p class="page-desc">ä¸ºæ¯ä¸ª Agent å’Œä»»åŠ¡ç±»å‹é€‰æ‹©æœ€é€‚åˆçš„æ¨¡å‹</p>
                        </div>
                        
                        <div id="agent-models-loading" class="empty-state">
                            <div class="empty-state-icon animate-spin"><svg class="icon icon-xl" style="width: 48px; height: 48px;" viewBox="0 0 24 24"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg></div>
                            <p class="empty-state-desc">åŠ è½½æ¨¡å‹é…ç½®...</p>
                        </div>
                        
                        <div id="agent-models-content" style="display: none;">
                            <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                                <button class="btn btn-primary" onclick="saveAgentModels()">ä¿å­˜æ¨¡å‹é…ç½®</button>
                                <button class="btn btn-secondary" onclick="resetToRecommendedModels()">é‡ç½®ä¸ºæ¨è</button>
                            </div>
                            
                            <div class="model-tabs" style="display: flex; gap: 0; margin-bottom: 16px; border-bottom: 1px solid var(--border);">
                                <button id="model-tab-agents" class="model-tab active" onclick="switchModelTab('agents')" style="padding: 10px 24px; background: none; border: none; border-bottom: 2px solid var(--accent); color: var(--text-primary); font-weight: 500; cursor: pointer;">è§’è‰²</button>
                                <button id="model-tab-categories" class="model-tab" onclick="switchModelTab('categories')" style="padding: 10px 24px; background: none; border: none; border-bottom: 2px solid transparent; color: var(--text-muted); font-weight: 500; cursor: pointer;">å·¥ä½œç±»å‹</button>
                            </div>
                            
                            <div id="model-tab-content-agents">
                                <div id="agent-models-list" style="display: grid; gap: var(--space-3);"></div>
                            </div>
                            
                            <div id="model-tab-content-categories" style="display: none;">
                                <div id="category-models-list" style="display: grid; gap: var(--space-3);"></div>
                            </div>
                        </div>
                        
                        <div id="agent-models-error" style="display: none; padding: var(--space-4); background: var(--danger-bg); border-radius: var(--radius-md); color: var(--danger);">
                            <p><svg class="icon" style="color: var(--danger); vertical-align: text-bottom;" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg> è¯·å…ˆé…ç½®æ¨¡å‹æœåŠ¡ï¼ˆåœ¨"æ¨¡å‹æœåŠ¡"é¡µé¢ï¼‰ï¼Œç„¶åå†é…ç½® Agent æ¨¡å‹ã€‚</p>
                        </div>
                    </div>

                    <!-- Tab 10: Backup & Restore -->
                    <div id="tab-10" class="tab-content hidden">
                        <div class="page-header">
                            <h2 class="page-title">å¤‡ä»½è¿˜åŸ</h2>
                            <p class="page-desc">ç®¡ç†é…ç½®å¤‡ä»½ï¼Œå¯éšæ—¶è¿˜åŸåˆ°å†å²ç‰ˆæœ¬</p>
                        </div>
                        
                        <div class="section">
                            <h3 class="section-title">åˆ›å»ºå¤‡ä»½</h3>
                            <p class="text-muted mb-4">æ‰‹åŠ¨åˆ›å»ºå½“å‰é…ç½®çš„å¤‡ä»½å¿«ç…§</p>
                            <button class="btn btn-primary" onclick="createManualBackup()">ç«‹å³å¤‡ä»½</button>
                        </div>
                        
                        <div class="section">
                            <h3 class="section-title">å¤‡ä»½å†å²</h3>
                            <p class="text-muted mb-4">ç³»ç»Ÿä¼šåœ¨æ¯æ¬¡ä¿å­˜é…ç½®æ—¶è‡ªåŠ¨åˆ›å»ºå¤‡ä»½ï¼Œæœ€å¤šä¿ç•™ 10 ä¸ªç‰ˆæœ¬</p>
                            <div id="backup-list"></div>
                        </div>
                    </div>

                    <!-- Tab 11: User Center (Merged) -->
                    <div id="tab-11" class="tab-content hidden">
                        <div class="page-header">
                            <h2 class="page-title">ç”¨æˆ·ä¸­å¿ƒ</h2>
                            <p class="page-desc">ç®¡ç†æ‰˜ç®¡æœåŠ¡è´¦å·ã€æŸ¥çœ‹ä½™é¢å’Œç”¨é‡ç»Ÿè®¡</p>
                        </div>
                        
                        <div id="uc-not-logged-in">
                            <div class="section" style="max-width: 400px; margin: 0 auto;">
                                <div id="uc-auth-form">
                                    <div id="uc-form-register">
                                        <div class="form-group">
                                            <label class="form-label">ç”¨æˆ·å</label>
                                            <input type="text" class="input" id="uc-reg-username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">é‚®ç®±</label>
                                            <input type="email" class="input" id="uc-reg-email" placeholder="è¯·è¾“å…¥é‚®ç®±">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">é‚®ç®±éªŒè¯ç </label>
                                            <div style="display: flex; gap: 8px;">
                                                <input type="text" class="input" id="uc-reg-code" placeholder="è¯·è¾“å…¥éªŒè¯ç " style="flex: 1;">
                                                <button class="btn btn-secondary" id="uc-send-code-btn" onclick="sendVerificationCode()" style="white-space: nowrap;">å‘é€éªŒè¯ç </button>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">å¯†ç </label>
                                            <input type="password" class="input" id="uc-reg-password" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘8ä½ï¼‰">
                                        </div>
                                        <button class="btn btn-primary" onclick="doRegister()" style="width: 100%; margin-bottom: var(--space-4);">æ³¨å†Œ</button>
                                        <div style="text-align: center; font-size: 13px; color: var(--text-muted);">
                                            å·²æœ‰è´¦å·ï¼Ÿ<a href="javascript:void(0)" onclick="switchToLogin()" style="color: var(--text-primary); text-decoration: underline;">ç«‹å³ç™»å½•</a>
                                        </div>
                                    </div>
                                    
                                    <div id="uc-form-login" class="hidden">
                                        <div class="form-group">
                                            <label class="form-label">ç”¨æˆ·å</label>
                                            <input type="text" class="input" id="uc-login-username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">å¯†ç </label>
                                            <input type="password" class="input" id="uc-login-password" placeholder="è¯·è¾“å…¥å¯†ç ">
                                        </div>
                                        <button class="btn btn-primary" onclick="doLogin()" style="width: 100%; margin-bottom: var(--space-4);">ç™»å½•</button>
                                        <div style="text-align: center; font-size: 13px; color: var(--text-muted);">
                                            <span id="uc-switch-account-link">æ²¡æœ‰è´¦å·ï¼Ÿ<a href="javascript:void(0)" onclick="switchToRegister()" style="color: var(--text-primary); text-decoration: underline;">ç«‹å³æ³¨å†Œ</a></span>
                                            <span id="uc-use-other-link" class="hidden"><a href="javascript:void(0)" onclick="switchToRegister()" style="color: var(--text-primary); text-decoration: underline;">ä½¿ç”¨å…¶ä»–è´¦å·</a></span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card" style="background: var(--bg-tertiary); padding: var(--space-4); cursor: default; margin-top: var(--space-6);">
                                    <h4 style="margin-bottom: var(--space-2); font-size: 14px;">ä¸ºä»€ä¹ˆä½¿ç”¨æ‰˜ç®¡æœåŠ¡ï¼Ÿ</h4>
                                    <ul style="color: var(--text-muted); padding-left: var(--space-4); margin: 0; text-align: left; font-size: 13px;">
                                        <li>æ— éœ€è‡ªå·±ç”³è¯·å„å®¶ API Key</li>
                                        <li>ç»Ÿä¸€çš„è®¡è´¹å’Œç”¨é‡ç®¡ç†</li>
                                        <li>é¢„é…ç½®çš„æœ€ä¼˜æ¨¡å‹ç»„åˆ</li>
                                        <li>ä¸€é”®åˆ‡æ¢åˆ°æ‰˜ç®¡æ¨¡å¼</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div id="uc-logged-in" class="hidden">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
                                <div>
                                    <span style="color: var(--text-muted);">å½“å‰è´¦å·ï¼š</span>
                                    <span id="uc-username" style="font-weight: var(--font-medium);"></span>
                                </div>
                                <div style="display: flex; gap: var(--space-2);">
                                    <a href="http://8.153.201.122:3000" target="_blank" class="btn btn-ghost btn-sm">ç®¡ç†åå°</a>
                                    <button class="btn btn-ghost btn-sm" onclick="doLogout()" style="color: var(--danger);">é€€å‡º</button>
                                </div>
                            </div>
                            
                            <div style="display: flex; align-items: center; gap: var(--space-4); padding: var(--space-4); background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: var(--space-4);">
                                <div style="flex: 1; display: flex; gap: var(--space-6);">
                                    <div>
                                        <div style="font-size: 11px; color: var(--text-muted);">ä½™é¢</div>
                                        <div id="uc-balance" style="font-size: 20px; font-weight: 600; color: var(--text-primary);">$0.00</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: var(--text-muted);">å·²ç”¨</div>
                                        <div id="uc-used-quota" style="font-size: 20px; font-weight: 600; color: var(--accent);">$0.00</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: var(--text-muted);">è°ƒç”¨</div>
                                        <div id="uc-total-requests" style="font-size: 20px; font-weight: 600; color: var(--success);">0</div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: var(--space-2);">
                                    <button class="btn btn-secondary btn-sm" onclick="showBuyModal()">è´­ä¹°</button>
                                    <button class="btn btn-secondary btn-sm" onclick="showRedeemModal()">å…‘æ¢</button>
                                    <button class="btn btn-ghost btn-sm" onclick="showInviteModal()">é‚€è¯· <span id="uc-aff-count" style="color: var(--warning);">0</span></button>
                                </div>
                            </div>
                            
                            <div style="border-bottom: 1px solid var(--border); margin-bottom: var(--space-4);">
                                <div style="display: flex; gap: var(--space-1);">
                                    <button class="uc-tab active" onclick="switchUcTab('overview')" id="uc-tab-overview">æ¦‚è§ˆ</button>
                                    <button class="uc-tab" onclick="switchUcTab('plan')" id="uc-tab-plan">å¥—é¤</button>
                                    <button class="uc-tab" onclick="switchUcTab('keys')" id="uc-tab-keys">å¯†é’¥</button>
                                </div>
                            </div>
                            
                            <div id="uc-panel-overview">
                                <div class="section">
                                    <h3 class="section-title">ç”¨é‡è¶‹åŠ¿</h3>
                                    <div id="usage-chart" style="height: 160px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: var(--space-4); position: relative;">
                                        <div id="usage-chart-bars" style="display: flex; align-items: flex-end; justify-content: space-around; height: 100px;"></div>
                                        <div id="usage-chart-labels" style="display: flex; justify-content: space-around; margin-top: var(--space-2); font-size: 11px; color: var(--text-muted);"></div>
                                        <div id="usage-chart-empty" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--text-muted);">æš‚æ— ç”¨é‡æ•°æ®</div>
                                    </div>
                                </div>
                                
                                <div class="section">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-3);">
                                        <h3 class="section-title" style="margin: 0; border: none; padding: 0;">æ¶ˆè´¹è®°å½•</h3>
                                        <button class="btn btn-ghost btn-sm" onclick="refreshLogs()">åˆ·æ–°</button>
                                    </div>
                                    <table class="table">
                                        <thead>
                                            <tr><th>æ—¶é—´</th><th>æ¨¡å‹</th><th>Token</th><th>æ¶ˆè€—</th></tr>
                                        </thead>
                                        <tbody id="uc-logs-body">
                                            <tr><td colspan="4" class="text-muted" style="text-align: center; padding: var(--space-6);">æš‚æ— æ¶ˆè´¹è®°å½•</td></tr>
                                        </tbody>
                                    </table>
                                    <div id="uc-logs-pagination" style="display: flex; justify-content: center; gap: var(--space-2); margin-top: var(--space-4);"></div>
                                </div>
                            </div>
                            
                            <div id="uc-panel-plan" class="hidden">
                                <div class="section">
                                    <h3 class="section-title">é€‰æ‹©å¥—é¤</h3>
                                    <p style="font-size: 13px; color: var(--text-muted); margin-bottom: var(--space-4);">é€‰æ‹©é€‚åˆæ‚¨çš„å¥—é¤ï¼Œäº«å—ä¸åŒçº§åˆ«çš„æ¨¡å‹æœåŠ¡</p>
                                    <div class="grid-3" id="uc-plan-options">
                                        <div class="card selectable" onclick="selectPlan('free')" id="plan-free" style="padding: var(--space-5);">
                                            <div style="font-weight: 600; margin-bottom: var(--space-2);">å…è´¹ç‰ˆ</div>
                                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: var(--space-3);">é€‚åˆè½»åº¦ä½¿ç”¨</div>
                                            <div style="font-size: 11px; color: var(--text-secondary);">DeepSeek + Gemini Flash</div>
                                        </div>
                                        <div class="card selectable" onclick="selectPlan('pro')" id="plan-pro" style="padding: var(--space-5);">
                                            <div style="font-weight: 600; margin-bottom: var(--space-2);">ä¸“ä¸šç‰ˆ</div>
                                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: var(--space-3);">æ—¥å¸¸å¼€å‘æ¨è</div>
                                            <div style="font-size: 11px; color: var(--text-secondary);">Claude Sonnet + Gemini Pro</div>
                                        </div>
                                        <div class="card selectable" onclick="selectPlan('ultimate')" id="plan-ultimate" style="padding: var(--space-5);">
                                            <div style="font-weight: 600; margin-bottom: var(--space-2);">æ——èˆ°ç‰ˆ</div>
                                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: var(--space-3);">å¤æ‚é¡¹ç›®é¦–é€‰</div>
                                            <div style="font-size: 11px; color: var(--text-secondary);">Claude Opus + GPT-5</div>
                                        </div>
                                    </div>
                                    <div id="uc-config-status" style="margin-top: var(--space-4);"></div>
                                </div>
                            </div>
                            
                            <div id="uc-panel-keys" class="hidden">
                                <div class="section">
                                    <h3 class="section-title">API å¯†é’¥ç®¡ç†</h3>
                                    <div id="uc-tokens-list" style="margin-bottom: var(--space-4);"></div>
                                    <div style="display: flex; gap: var(--space-3); align-items: center; margin-bottom: var(--space-4);">
                                        <input type="text" class="input" id="new-token-name" placeholder="å¯†é’¥åç§°" style="max-width: 200px;">
                                        <button class="btn btn-secondary" onclick="createToken()">åˆ›å»ºå¯†é’¥</button>
                                    </div>
                                </div>
                                <div class="section">
                                    <h3 class="section-title">åº”ç”¨åˆ° OpenCode</h3>
                                    <div style="display: flex; gap: var(--space-3); align-items: center;">
                                        <select class="input" id="uc-token-select" style="max-width: 280px;">
                                            <option value="">-- é€‰æ‹©å¯†é’¥ --</option>
                                        </select>
                                        <button class="btn btn-primary" onclick="applyConfig()">åº”ç”¨é…ç½®</button>
                                        <button class="btn btn-ghost btn-sm" onclick="removeConfig()" style="color: var(--danger);">ç§»é™¤</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="uc-modal-overlay" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 100; display: flex; align-items: center; justify-content: center;" onclick="closeUcModal(event)">
                            <div id="uc-modal-content" style="background: var(--bg-card); border-radius: var(--radius); padding: var(--space-6); min-width: 320px; max-width: 400px;" onclick="event.stopPropagation()">
                                <div id="uc-modal-buy" class="hidden">
                                    <h3 style="margin-bottom: var(--space-4);">è´­ä¹°é¢åº¦</h3>
                                    <p style="color: var(--text-muted); font-size: 13px;">è¯¥åŠŸèƒ½æš‚æœªå¼€æ”¾ï¼Œæ•¬è¯·æœŸå¾…</p>
                                    <button class="btn btn-secondary" onclick="closeUcModal()" style="margin-top: var(--space-4);">å…³é—­</button>
                                </div>
                                <div id="uc-modal-redeem" class="hidden">
                                    <h3 style="margin-bottom: var(--space-4);">å…‘æ¢ç </h3>
                                    <div class="form-group">
                                        <input type="text" class="input" id="redeem-code-input" placeholder="è¯·è¾“å…¥å…‘æ¢ç ">
                                    </div>
                                    <div style="display: flex; gap: var(--space-3);">
                                        <button class="btn btn-primary" onclick="redeemCode()">å…‘æ¢</button>
                                        <button class="btn btn-ghost" onclick="closeUcModal()">å–æ¶ˆ</button>
                                    </div>
                                </div>
                                <div id="uc-modal-invite" class="hidden">
                                    <h3 style="margin-bottom: var(--space-4);">é‚€è¯·å¥½å‹</h3>
                                    <div class="form-group">
                                        <label class="form-label">é‚€è¯·é“¾æ¥</label>
                                        <div style="display: flex; gap: var(--space-2);">
                                            <input type="text" class="input" id="uc-invite-link" readonly style="font-size: 12px;">
                                            <button class="btn btn-primary btn-sm" onclick="copyInviteLink()">å¤åˆ¶</button>
                                        </div>
                                    </div>
                                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: var(--space-4);">
                                        é‚€è¯·å¥–åŠ±ï¼š<span id="uc-aff-quota" style="color: var(--success);">$0.00</span>
                                    </div>
                                    <button class="btn btn-ghost" onclick="closeUcModal()">å…³é—­</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab 12: Feishu Bot -->
                    <div id="tab-12" class="tab-content hidden">
                        <div class="page-header">
                            <h2 class="page-title">é£ä¹¦æœºå™¨äºº</h2>
                            <p class="page-desc">é…ç½®å¹¶è¿è¡Œé£ä¹¦æœºå™¨äººï¼Œæ”¯æŒæ¶ˆæ¯æ¥æ”¶å’Œäº¤äº’</p>
                        </div>
                        
                        <div class="section">
                            <h3 class="section-title">åŸºæœ¬é…ç½®</h3>
                            <div class="form-group">
                                <label class="form-label">App ID</label>
                                <input type="text" class="input" id="feishu-app-id" placeholder="cli_...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">App Secret</label>
                                <input type="password" class="input" id="feishu-app-secret" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                            </div>
                            <div class="form-group">
                                <label class="form-label">OpenCode å·¥ä½œç›®å½•</label>
                                <input type="text" class="input" id="feishu-working-dir" placeholder="/Users/leng/Desktop/codepro/opencraft" value="/Users/leng/Desktop/codepro/opencraft">
                            </div>
                            <div class="checkbox-wrapper mb-4">
                                <input type="checkbox" id="feishu-server-mode" class="checkbox" checked>
                                <label for="feishu-server-mode">ä½¿ç”¨ Server æ¨¡å¼ (æ¨è)</label>
                            </div>
                            
                            <details style="margin-bottom: 16px;">
                                <summary style="cursor: pointer; color: var(--text-secondary); font-size: 13px; margin-bottom: 8px;">é«˜çº§è®¾ç½®</summary>
                                <div style="padding-top: 8px;">
                                    <div class="grid-2">
                                        <div class="form-group">
                                            <label class="form-label">Server Host</label>
                                            <input type="text" class="input" id="feishu-server-host" value="127.0.0.1">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Server Port</label>
                                            <input type="number" class="input" id="feishu-server-port" value="4096">
                                        </div>
                                    </div>
                                </div>
                            </details>
                            
                            <div class="flex gap-3">
                                <button class="btn btn-primary" onclick="saveFeishuConfig()">ä¿å­˜é…ç½®</button>
                                <button class="btn btn-secondary" onclick="window.api.openExternal('https://open.feishu.cn/document/home/index')">å¼€å‘æ–‡æ¡£</button>
                            </div>
                        </div>
                        
                        <div class="section">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="section-title" style="margin-bottom: 0; border: none;">è¿è¡Œæ§åˆ¶</h3>
                                <div id="feishu-status-indicator" style="display: flex; align-items: center; gap: 6px; font-size: 13px;">
                                    <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--text-muted);"></div>
                                    <span class="text-muted">æœªè¿è¡Œ</span>
                                </div>
                            </div>
                            
                            <div class="flex gap-3 mb-4">
                                <button class="btn btn-primary" id="btn-start-feishu" onclick="startFeishuBot()">
                                    <svg class="icon icon-sm" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg> å¯åŠ¨æœºå™¨äºº
                                </button>
                                <button class="btn btn-secondary" id="btn-stop-feishu" onclick="stopFeishuBot()" disabled>
                                    <svg class="icon icon-sm" viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg> åœæ­¢æœºå™¨äºº
                                </button>
                            </div>
                            
                            <div class="code-block" id="feishu-log-area" style="height: 300px; overflow-y: auto; display: block; white-space: pre-wrap; font-family: var(--font-mono); font-size: 12px; color: var(--text-secondary);">
                                <div class="text-muted">ç­‰å¾…å¯åŠ¨...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="toast" class="toast"></div>
    </div>

    <script>
        // Data Definitions
        const frontendStacks = [
            { id: 'react', name: 'React', icon: '<svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>' },
            { id: 'vue', name: 'Vue', icon: '<svg class="icon" viewBox="0 0 24 24"><path d="M22 2L12 22 2 2h20z"/></svg>' },
            { id: 'nextjs', name: 'Next.js', icon: '<svg class="icon" viewBox="0 0 24 24"><path d="M12 2L2 22h20L12 2z"/></svg>' },
            { id: 'none', name: 'æ— å‰ç«¯', icon: '<svg class="icon" viewBox="0 0 24 24"><line x1="5" y1="12" x2="19" y2="12"/></svg>' }
        ];
        
        const backendStacks = [
            { id: 'python', name: 'Python', icon: '<svg class="icon" viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>' },
            { id: 'java', name: 'Java', icon: '<svg class="icon" viewBox="0 0 24 24"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>' },
            { id: 'nodejs', name: 'Node.js', icon: '<svg class="icon" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>' },
            { id: 'none', name: 'æ— åç«¯', icon: '<svg class="icon" viewBox="0 0 24 24"><line x1="5" y1="12" x2="19" y2="12"/></svg>' }
        ];

        const styles = [
            { id: 'glassmorphism', name: 'ç»ç’ƒæ‹Ÿæ€', icon: '<svg class="icon" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>' },
            { id: 'neumorphism', name: 'æ–°æ‹Ÿæ€', icon: '<svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/></svg>' },
            { id: 'minimalist', name: 'æç®€ä¸»ä¹‰', icon: '<svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/></svg>' },
            { id: 'brutalist', name: 'ç²—é‡ä¸»ä¹‰', icon: '<svg class="icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18"/></svg>' },
            { id: 'flat-design', name: 'æ‰å¹³è®¾è®¡', icon: '<svg class="icon" viewBox="0 0 24 24"><polygon points="12 2 2 22 22 22 12 2"/></svg>' },
            { id: 'material-design', name: 'Material', icon: '<svg class="icon" viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M3 12h18"/><path d="M3 18h18"/></svg>' },
            { id: 'dark-mode', name: 'æ·±è‰²æ¨¡å¼', icon: '<svg class="icon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>' },
            { id: 'gradient-heavy', name: 'æ¸å˜é£æ ¼', icon: '<svg class="icon" viewBox="0 0 24 24"><path d="M17 18a5 5 0 0 0-10 0"/></svg>' },
            { id: 'cyberpunk', name: 'èµ›åšæœ‹å…‹', icon: '<svg class="icon" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"/><rect x="9" y="9" width="6" height="6"/><line x1="9" y1="1" x2="9" y2="4"/><line x1="15" y1="1" x2="15" y2="4"/><line x1="9" y1="20" x2="9" y2="23"/><line x1="15" y1="20" x2="15" y2="23"/><line x1="20" y1="9" x2="23" y2="9"/><line x1="20" y1="14" x2="23" y2="14"/><line x1="1" y1="9" x2="4" y2="9"/><line x1="1" y1="14" x2="4" y2="14"/></svg>' },
            { id: 'retro-futurism', name: 'å¤å¤æœªæ¥', icon: '<svg class="icon" viewBox="0 0 24 24"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.48-.56.93-1.23 1.35-2h-4.35z"/><path d="M9.85 14.85l-4.35 4.35"/><path d="M12 2l3 3 7 7-3 3-7-7-3-3z"/></svg>' },
            { id: 'organic-shapes', name: 'æœ‰æœºå½¢æ€', icon: '<svg class="icon" viewBox="0 0 24 24"><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"/><line x1="16" y1="8" x2="2" y2="22"/><line x1="17.5" y1="15" x2="9" y2="15"/></svg>' },
            { id: 'swiss-style', name: 'ç‘å£«é£æ ¼', icon: '<svg class="icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>' }
        ];

        const categoryDefinitions = [
            { 
                id: 'visual-engineering', 
                name: 'å‰ç«¯/UI', 
                icon: '<svg class="icon" viewBox="0 0 24 24"><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.55 0 1-.45 1-1 0-1.25.8-2 2-2 1.35 0 2.45-.9 2.75-2.1.35-1.4.35-2.85-.75-3.65-.25-.2-.4-.45-.4-.75 0-1.1 1.25-1.75 2.5-1.1.55.3 1.25-.1 1.25-.7 0-4.95-4.5-9-10-9z"/></svg>',
                description: 'Frontend, UI/UX, design, styling, animation',
                recommendedType: 'creative',
                defaultModel: 'google/gemini-3-pro'
            },
            { 
                id: 'ultrabrain', 
                name: 'å¤æ‚é€»è¾‘', 
                icon: '<svg class="icon" viewBox="0 0 24 24"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>',
                description: 'å¤æ‚æ¶æ„ã€æ·±åº¦é€»è¾‘æ¨ç†',
                recommendedType: 'reasoning',
                defaultModel: 'openai/gpt-5.2-codex'
            },
            { 
                id: 'deep', 
                name: 'æ·±åº¦ç ”ç©¶', 
                icon: '<svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',
                description: 'ç›®æ ‡å¯¼å‘çš„è‡ªä¸»é—®é¢˜è§£å†³',
                recommendedType: 'reasoning',
                defaultModel: 'openai/gpt-5.2-codex'
            },
            { 
                id: 'artistry', 
                name: 'åˆ›æ„ä»»åŠ¡', 
                icon: '<svg class="icon" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
                description: 'é«˜åº¦åˆ›æ„/è‰ºæœ¯æ€§ä»»åŠ¡',
                recommendedType: 'creative',
                defaultModel: 'google/gemini-3-pro'
            },
            { 
                id: 'quick', 
                name: 'å¿«é€Ÿä»»åŠ¡', 
                icon: '<svg class="icon" viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
                description: 'ç®€å•ä»»åŠ¡ - å•æ–‡ä»¶ä¿®æ”¹ã€typoä¿®å¤',
                recommendedType: 'fast',
                defaultModel: 'anthropic/claude-haiku-4-5'
            },
            { 
                id: 'writing', 
                name: 'æ–‡æ¡£å†™ä½œ', 
                icon: '<svg class="icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>',
                description: 'æ–‡æ¡£ã€æ•£æ–‡ã€æŠ€æœ¯å†™ä½œ',
                recommendedType: 'writing',
                defaultModel: 'google/gemini-3-flash'
            }
        ];

        const modelTypeKeywords = {
            reasoning: ['codex', 'o1', 'o3', 'opus', 'thinking', 'pro'],
            creative: ['gemini', 'pro', 'opus', 'sonnet'],
            fast: ['haiku', 'flash', 'mini', 'fast'],
            writing: ['flash', 'sonnet', 'gemini']
        };

        // State
        let state = {
            view: 'wizard',
            step: 1,
            activeTab: 0,
            deployTab: 'fc',
            config: {
                frontend: '',
                backend: '',
                style: '',
                webhookType: 'feishu',
                webhookUrl: '',
                webhookSecret: '',
                notifyDeploy: false,
                notifyError: false,
                dbType: 'postgres',
                dbHost: 'localhost',
                dbPort: '5432',
                dbUsername: '',
                dbPassword: '',
                dbName: '',
                deployPlatform: 'aliyun-fc',
                accessKeyId: '',
                accessKeySecret: '',
                region: 'cn-hangzhou',
                serviceName: '',
                functionName: ''
            },
            credentials: {
                proxyName: '',
                apiFormat: 'openai',
                apiKey: '',
                baseUrl: ''
            },
            providers: [],
            imageService: {
                url: '',
                apiKey: '',
                skillInstalled: false
            },
            fcAccounts: [],
            dockerRegistries: [],
            ecsServers: [],
            dbConnections: {},
            promptAppends: {},
            categoryModels: {}
        };

        // DOM Elements
        const el = (id) => document.getElementById(id);

        // Theme Management
        function setTheme(themeName) {
            document.documentElement.setAttribute('data-theme', themeName);
            localStorage.setItem('omo-theme', themeName);
            updateThemeButtons(themeName);
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('omo-theme') || 'minimalist';
            setTheme(savedTheme);
        }

        function updateThemeButtons(activeTheme) {
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const themeMap = {
                'minimalist': '.theme-btn-minimalist',
                'glassmorphism': '.theme-btn-glass',
                'swiss': '.theme-btn-swiss'
            };
            const activeBtn = document.querySelector(themeMap[activeTheme]);
            if (activeBtn) activeBtn.classList.add('active');
        }

        // Initialization
        async function init() {
            loadTheme();
            try {
                // Load saved app config
                const savedConfig = await window.api.loadConfig();
                if (savedConfig && savedConfig.success && savedConfig.data) {
                    state.config = { ...state.config, ...savedConfig.data };
                    if (savedConfig.data.imageService) {
                        state.imageService.url = savedConfig.data.imageService.url || '';
                        state.imageService.apiKey = savedConfig.data.imageService.apiKey || '';
                    }
                }
                
                const savedCreds = await window.api.loadCredentials();
                if (savedCreds && savedCreds.success && savedCreds.data) {
                    state.credentials = { ...state.credentials, ...savedCreds.data };
                }

                // Load real OpenCode/Oh-My-OpenCode configs
                const realConfigs = await window.api.loadAllConfigs();
                if (realConfigs.success && realConfigs.configs) {
                    const { opencode, ohMyOpencode, auth } = realConfigs.configs;
                    
                    // Merge opencode.json settings
                    if (opencode) {
                        if (opencode.provider) {
                            // Populate providers list
                            state.providers = Object.entries(opencode.provider).map(([key, config]) => {
                                // Infer apiFormat from npm package
                                let apiFormat = 'openai';
                                if (config.npm) {
                                    if (config.npm.includes('anthropic')) apiFormat = 'anthropic';
                                    else if (config.npm.includes('google')) apiFormat = 'gemini';
                                }
                                return {
                                    name: key,  // provider key (ç”¨äºå¼•ç”¨)
                                    displayName: config.name || '',  // æ˜¾ç¤ºåç§°
                                    apiFormat,
                                    baseUrl: config.options?.baseURL || '',
                                    apiKey: config.options?.apiKey || '', // ä» options è¯»å– apiKey
                                    npm: config.npm || '',
                                    models: config.models || {}
                                };
                            });

                            const providerKeys = Object.keys(opencode.provider);
                            if (providerKeys.length > 0) {
                                const firstProvider = opencode.provider[providerKeys[0]];
                                state.credentials.proxyName = providerKeys[0];
                                if (firstProvider.options && firstProvider.options.baseURL) {
                                    state.credentials.baseUrl = firstProvider.options.baseURL;
                                }
                            }
                        }
                    }
                    
                    // Merge oh-my-opencode.json settings
                    if (ohMyOpencode) {
                        if (ohMyOpencode.frontend) state.config.frontend = ohMyOpencode.frontend;
                        if (ohMyOpencode.backend) state.config.backend = ohMyOpencode.backend;
                        if (ohMyOpencode.designStyle) state.config.style = ohMyOpencode.designStyle;
                        
                        // Load prompt appends
                        if (ohMyOpencode.categories) {
                            state.promptAppends = {};
                            for (const [key, value] of Object.entries(ohMyOpencode.categories)) {
                                if (value.prompt_append) {
                                    state.promptAppends[key] = value.prompt_append;
                                }
                            }
                        }
                    }
                    
                    // Merge auth.json settings
                    if (auth) {
                        // Fill keys for providers - match by provider NAME, not apiFormat
                        state.providers.forEach(p => {
                            // Try exact name match first
                            if (auth[p.name] && auth[p.name].key) {
                                p.apiKey = auth[p.name].key;
                            }
                            // Also try apiFormat match as fallback
                            else if (auth[p.apiFormat] && auth[p.apiFormat].key) {
                                p.apiKey = auth[p.apiFormat].key;
                            }
                        });

                        const authKeys = Object.keys(auth);
                        if (authKeys.length > 0) {
                            const firstAuth = auth[authKeys[0]];
                            if (firstAuth && firstAuth.key) {
                                state.credentials.apiKey = firstAuth.key;
                            }
                            // Detect API format from auth key name
                            if (authKeys[0].includes('openai')) state.credentials.apiFormat = 'openai';
                            else if (authKeys[0].includes('anthropic')) state.credentials.apiFormat = 'anthropic';
                            else if (authKeys[0].includes('gemini')) state.credentials.apiFormat = 'gemini';
                        }
                    }
                }

                // Check status
                const status = await window.api.checkInitStatus();
                const isInit = status && !status.needsSetup;
                
                if (isInit) {
                    state.view = 'dashboard';
                    showDashboard();
                } else {
                    state.view = 'wizard';
                    showWizard();
                }
                
                renderOptions();
                bindInputs();
                
                // Load additional data for dashboard
                if (state.view === 'dashboard') {
                    loadAgentsMd();
                    loadPromptAppends();
                }
            } catch (e) {
                console.error('Init failed', e);
                // Fallback to wizard if error
                state.view = 'wizard';
                showWizard();
                renderOptions();
            }
        }

        // --- Render Functions ---

        function renderOptions() {
            // Render Tech Stacks (Wizard & Dashboard)
            const renderCards = (items, containerId, category, isDashboard) => {
                const container = el(containerId);
                if (!container) return;
                container.innerHTML = items.map(item => `
                    <div class="card ${state.config[category] === item.id ? 'selected' : ''}" 
                         onclick="${isDashboard ? 'selectDashStack' : 'selectWizStack'}('${category}', '${item.id}')">
                        <div class="card-icon">${item.icon}</div>
                        <div class="card-title">${item.name}</div>
                    </div>
                `).join('');
            };

            renderCards(frontendStacks, 'wizard-frontend-options', 'frontend', false);
            renderCards(backendStacks, 'wizard-backend-options', 'backend', false);
            renderCards(frontendStacks, 'dash-frontend-options', 'frontend', true);
            renderCards(backendStacks, 'dash-backend-options', 'backend', true);

            // Render Styles
            const renderStyles = (containerId, isDashboard) => {
                const container = el(containerId);
                if (!container) return;
                container.innerHTML = styles.map(item => `
                    <div class="card ${state.config.style === item.id ? 'selected' : ''}" 
                         onclick="${isDashboard ? 'selectDashStyle' : 'selectWizStyle'}('${item.id}')">
                        <div class="card-icon">${item.icon}</div>
                        <div class="card-title">${item.name}</div>
                    </div>
                `).join('');
            };

            renderStyles('wizard-style-options', false);
            renderStyles('dash-style-options', true);
        }

        function bindInputs() {
            // Bind Dashboard Inputs to State
            const bind = (id, obj, key, type = 'value') => {
                const element = el(id);
                if (!element) return;
                if (type === 'checkbox') {
                    element.checked = state[obj][key];
                    element.onchange = (e) => state[obj][key] = e.target.checked;
                } else {
                    element.value = state[obj][key] || '';
                    element.oninput = (e) => state[obj][key] = e.target.value;
                }
            };

            // Webhook
            bind('webhook-type', 'config', 'webhookType');
            bind('webhook-url', 'config', 'webhookUrl');
            bind('webhook-secret', 'config', 'webhookSecret');
            bind('notify-deploy', 'config', 'notifyDeploy', 'checkbox');
            bind('notify-error', 'config', 'notifyError', 'checkbox');

            // Database
            bind('db-type', 'config', 'dbType');
            bind('db-host', 'config', 'dbHost');
            bind('db-port', 'config', 'dbPort');
            bind('db-username', 'config', 'dbUsername');
            bind('db-password', 'config', 'dbPassword');
            bind('db-name', 'config', 'dbName');

            // Deploy
            bind('deploy-platform', 'config', 'deployPlatform');
            bind('deploy-ak-id', 'config', 'accessKeyId');
            bind('deploy-ak-secret', 'config', 'accessKeySecret');
            bind('deploy-region', 'config', 'region');
            bind('deploy-service', 'config', 'serviceName');
            bind('deploy-function', 'config', 'functionName');

            // Model (Dashboard)
            bind('dash-proxy-name', 'credentials', 'proxyName');
            bind('dash-api-format', 'credentials', 'apiFormat');
            bind('dash-base-url', 'credentials', 'baseUrl');
            bind('dash-api-key', 'credentials', 'apiKey');
            
            // Model (Wizard)
            bind('wiz-proxy-name', 'credentials', 'proxyName');
            bind('wiz-api-format', 'credentials', 'apiFormat');
            bind('wiz-base-url', 'credentials', 'baseUrl');
            bind('wiz-api-key', 'credentials', 'apiKey');
        }

        // --- Wizard Logic ---

        function resetToWizard() {
            if (confirm('ç¡®å®šè¦é‡æ–°è¿›å…¥å®‰è£…å¼•å¯¼å—ï¼Ÿå½“å‰é…ç½®ä¸ä¼šè¢«åˆ é™¤ã€‚')) {
                state.step = 1;
                state.view = 'wizard';
                window.api.installSkills();
                showWizard();
            }
        }

        function showWizard() {
            el('wizard-view').classList.remove('hidden');
            el('dashboard-view').classList.add('hidden');
            updateWizardStep();
        }

        function updateWizardStep() {
            // Hide all steps
            for (let i = 1; i <= 5; i++) el(`step-${i}`).classList.add('hidden');
            // Show current
            el(`step-${state.step}`).classList.remove('hidden');
            
            // Update dots
            const dotsContainer = el('wizard-dots');
            dotsContainer.innerHTML = '';
            for (let i = 1; i <= 5; i++) {
                const dot = document.createElement('div');
                dot.className = `progress-dot ${i === state.step ? 'active' : ''}`;
                dotsContainer.appendChild(dot);
            }

            // Update buttons
            const prevBtn = el('btn-prev');
            const nextBtn = el('btn-next');
            
            prevBtn.style.visibility = state.step === 1 ? 'hidden' : 'visible';
            nextBtn.textContent = state.step === 5 ? 'å®Œæˆé…ç½®' : 'ä¸‹ä¸€æ­¥';
            
            // Validation for Next button
            validateStep();
        }

        function validateStep() {
            const nextBtn = el('btn-next');
            let isValid = true;
            
            if (state.step === 1) {
                isValid = el('check-opencode').checked;
            } else if (state.step === 2) {
                isValid = el('check-omo').checked;
            } else if (state.step === 3) {
                isValid = state.config.frontend && state.config.backend;
            } else if (state.step === 4) {
                isValid = state.config.style;
            } else if (state.step === 5) {
                isValid = true; // API é…ç½®å¯é€‰ï¼Œå…è®¸è·³è¿‡
            }
            
            nextBtn.disabled = !isValid;
            nextBtn.style.opacity = isValid ? '1' : '0.5';
        }

        window.toggleNextBtn = (checked) => {
            validateStep();
        };

        window.prevStep = () => {
            if (state.step > 1) {
                state.step--;
                updateWizardStep();
            }
        };

        window.nextStep = async () => {
            if (state.step < 5) {
                state.step++;
                updateWizardStep();
            } else {
                // Finish
                await window.api.installSkills();
                await saveAll();
                state.view = 'dashboard';
                showDashboard();
                showToast('é…ç½®å·²å®Œæˆï¼');
            }
        };

        window.selectWizStack = (category, id) => {
            state.config[category] = id;
            renderOptions();
            validateStep();
        };

        window.selectWizStyle = (id) => {
            state.config.style = id;
            renderOptions();
            validateStep();
        };

        window.copyCommand = () => {
            const cmd = el('install-cmd').innerText;
            window.api.copyToClipboard(cmd); // Assuming this API exists or use navigator
            if (navigator.clipboard) navigator.clipboard.writeText(cmd);
            showToast('å‘½ä»¤å·²å¤åˆ¶');
        };

        // --- Dashboard Logic ---

        function showDashboard() {
            el('wizard-view').classList.add('hidden');
            el('dashboard-view').classList.remove('hidden');
            switchTab(state.activeTab);
        }

        window.switchTab = (index) => {
            state.activeTab = index;
            for (let i = 0; i <= 12; i++) {
                const nav = el(`nav-${i}`);
                const tab = el(`tab-${i}`);
                if (nav) nav.classList.toggle('active', i === index);
                if (tab) tab.classList.toggle('hidden', i !== index);
            }
            
            if (index === 2) {
                if (typeof backToProviderList === 'function') {
                    backToProviderList();
                } else {
                    renderProviderList();
                }
            }
            if (index === 3) loadWebhookConfig();
            if (index === 4) loadSqlConfig();
            if (index === 5) {
                if (!state.deployTab) state.deployTab = 'fc';
                switchDeployTab(state.deployTab);
            }
            if (index === 6) loadAgentsMd();
            if (index === 7) loadPromptAppends();
            if (index === 8) {
                const urlInput = document.getElementById('image-service-url');
                const keyInput = document.getElementById('image-service-key');
                if (urlInput) urlInput.value = state.imageService.url || '';
                if (keyInput) keyInput.value = state.imageService.apiKey || '';
                checkImageSkillStatus();
            }
            if (index === 9) loadAgentModels();
            if (index === 10) loadBackupList();
            if (index === 11) loadUserCenter();
            if (index === 12) loadFeishuConfig();
        };

        window.toggleNavGroup = (header) => {
            const group = header.parentElement;
            group.classList.toggle('collapsed');
        };

        window.toggleNavGroup = (header) => {
            const group = header.parentElement;
            group.classList.toggle('collapsed');
        };

        window.selectDashStack = (category, id) => {
            state.config[category] = id;
            renderOptions();
        };

        // --- Provider Management ---

        function renderProviderList() {
            const tbody = document.getElementById('provider-table-body');
            if (!tbody) return;
            
            tbody.innerHTML = state.providers.map((p, i) => {
                const modelCount = Object.keys(p.models || {}).length;
                const formatLabel = p.apiFormat === 'anthropic' ? 'Anthropic' : 
                                    p.apiFormat === 'gemini' ? 'Gemini' : 'OpenAI';
                return `
                    <tr>
                        <td style="font-weight: var(--font-medium);">${p.displayName || p.name || 'æœªå‘½å'}<br><small style="color: var(--text-muted); font-weight: normal;">${p.name || ''}</small></td>
                        <td><span class="badge">${formatLabel}</span></td>
                        <td>${modelCount} ä¸ªæ¨¡å‹</td>
                        <td class="table-actions">
                            <button class="btn btn-ghost btn-sm" onclick="editProvider(${i})">ç¼–è¾‘</button>
                            <button class="btn btn-ghost btn-sm" onclick="editModels(${i})">æ¨¡å‹</button>
                            <button class="btn btn-ghost btn-sm" onclick="removeProvider(${i})" style="color: var(--danger);">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            }).join('') || '<tr><td colspan="4" class="empty-state" style="padding: var(--space-8);">æš‚æ— æœåŠ¡å•†é…ç½®ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ </td></tr>';
        }

        window.addProvider = () => {
            state.providers.push({ 
                name: '', 
                displayName: '',
                apiFormat: 'openai', 
                baseUrl: '', 
                apiKey: '',
                npm: '',
                models: {}
            });
            editProvider(state.providers.length - 1);
        };

        window.removeProvider = (index) => {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæœåŠ¡å•†å—ï¼Ÿ')) {
                state.providers.splice(index, 1);
                renderProviderList();
            }
        };

        window.editProvider = (index) => {
            state.editingProviderIndex = index;
            const p = state.providers[index];
            
            document.getElementById('provider-list-view').classList.add('hidden');
            document.getElementById('provider-edit-view').classList.remove('hidden');
            document.getElementById('model-list-view').classList.add('hidden');
            
            document.getElementById('provider-edit-view').innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 24px;">
                    <button class="btn" onclick="backToProviderList()" style="margin-right: 16px;">â† è¿”å›</button>
                    <h3 style="margin: 0;">ç¼–è¾‘æœåŠ¡å•†: ${p.displayName || p.name || 'æ–°æœåŠ¡å•†'}</h3>
                </div>
                
                <div class="form-group">
                    <label class="form-label">æœåŠ¡å•† IDï¼ˆå”¯ä¸€æ ‡è¯†ï¼Œç”¨äºé…ç½®å¼•ç”¨ï¼‰</label>
                    <input type="text" class="input" id="edit-provider-name" value="${p.name || ''}" placeholder="å¦‚: my-proxy">
                    <p class="form-hint">ç”¨äº model é…ç½®ä¸­å¼•ç”¨ï¼Œå¦‚ my-proxy/gpt-4</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">æ˜¾ç¤ºåç§°</label>
                    <input type="text" class="input" id="edit-provider-display-name" value="${p.displayName || ''}" placeholder="å¦‚: æˆ‘çš„ä»£ç†æœåŠ¡">
                </div>
                
                <div class="form-group">
                    <label class="form-label">æ¥å£æ ¼å¼</label>
                    <select class="select" id="edit-provider-format" onchange="updateNpmHint()">
                        <option value="openai" ${p.apiFormat === 'openai' ? 'selected' : ''}>OpenAI æ ¼å¼</option>
                        <option value="anthropic" ${p.apiFormat === 'anthropic' ? 'selected' : ''}>Anthropic æ ¼å¼</option>
                        <option value="gemini" ${p.apiFormat === 'gemini' ? 'selected' : ''}>Gemini æ ¼å¼</option>
                    </select>
                    <p class="form-hint">NPM åŒ…å°†è‡ªåŠ¨å…³è”ï¼š<span id="edit-provider-npm-hint">${getNpmPackageForFormat(p.apiFormat)}</span></p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">API åœ°å€</label>
                    <input type="text" class="input" id="edit-provider-url" value="${p.baseUrl || ''}" placeholder="https://api.example.com/v1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">API Key</label>
                    <input type="password" class="input" id="edit-provider-key" value="${p.apiKey || ''}">
                </div>
                
                <button class="btn btn-primary" onclick="saveProviderEdit()">ä¿å­˜</button>
            `;
        };

        window.saveProviderEdit = () => {
            const i = state.editingProviderIndex;
            state.providers[i].name = document.getElementById('edit-provider-name').value;
            state.providers[i].displayName = document.getElementById('edit-provider-display-name').value;
            state.providers[i].apiFormat = document.getElementById('edit-provider-format').value;
            state.providers[i].baseUrl = document.getElementById('edit-provider-url').value;
            state.providers[i].apiKey = document.getElementById('edit-provider-key').value;
            state.providers[i].npm = getNpmPackageForFormat(state.providers[i].apiFormat);
            
            backToProviderList();
            showToast('æœåŠ¡å•†é…ç½®å·²æ›´æ–°', 'success');
        };

        function getNpmPackageForFormat(format) {
            const npmMap = {
                'openai': '@ai-sdk/openai',
                'anthropic': '@ai-sdk/anthropic',
                'gemini': '@ai-sdk/google'
            };
            return npmMap[format] || '@ai-sdk/openai';
        }

        function updateNpmHint() {
            const format = document.getElementById('edit-provider-format').value;
            const hint = document.getElementById('edit-provider-npm-hint');
            if (hint) {
                hint.textContent = getNpmPackageForFormat(format);
            }
        }

        window.backToProviderList = () => {
            document.getElementById('provider-list-view').classList.remove('hidden');
            document.getElementById('provider-edit-view').classList.add('hidden');
            document.getElementById('model-list-view').classList.add('hidden');
            renderProviderList();
        };

        // --- Model Management ---

        window.editModels = (providerIndex) => {
            state.editingProviderIndex = providerIndex;
            
            document.getElementById('provider-list-view').classList.add('hidden');
            document.getElementById('provider-edit-view').classList.add('hidden');
            document.getElementById('model-list-view').classList.remove('hidden');
            
            renderModelList(providerIndex);
        };

        function renderModelList(providerIndex) {
            const p = state.providers[providerIndex];
            const models = Object.entries(p.models || {});
            
            document.getElementById('model-list-view').innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 24px;">
                    <button class="btn" onclick="backToProviderList()" style="margin-right: 16px;">â† è¿”å›</button>
                    <h3 style="margin: 0;">${p.name} - æ¨¡å‹é…ç½®</h3>
                </div>
                
                <div id="model-cards">
                    ${models.map(([modelId, model]) => `
                        <div style="border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <strong>${model.name || modelId}</strong>
                                <button class="btn" onclick="removeModel(${providerIndex}, '${modelId}')" style="color: #e74c3c; padding: 4px 8px;">åˆ é™¤</button>
                            </div>
                            
                            <div class="grid-2" style="gap: 12px;">
                                <div class="form-group" style="margin-bottom: 8px;">
                                    <label class="form-label" style="font-size: 12px;">æ¨¡å‹ ID</label>
                                    <input type="text" class="input" value="${modelId}" onchange="renameModel(${providerIndex}, '${modelId}', this.value)">
                                </div>
                                <div class="form-group" style="margin-bottom: 8px;">
                                    <label class="form-label" style="font-size: 12px;">æ˜¾ç¤ºåç§°</label>
                                    <input type="text" class="input" value="${model.name || ''}" onchange="updateModel(${providerIndex}, '${modelId}', 'name', this.value)">
                                </div>
                            </div>
                            
                            <div class="grid-2" style="gap: 12px;">
                                <div class="form-group" style="margin-bottom: 8px;">
                                    <label class="form-label" style="font-size: 12px;">ä¸Šä¸‹æ–‡é™åˆ¶</label>
                                    <input type="number" class="input" value="${model.limit?.context || 200000}" onchange="updateModelLimit(${providerIndex}, '${modelId}', 'context', parseInt(this.value))">
                                </div>
                                <div class="form-group" style="margin-bottom: 8px;">
                                    <label class="form-label" style="font-size: 12px;">è¾“å‡ºé™åˆ¶</label>
                                    <input type="number" class="input" value="${model.limit?.output || 64000}" onchange="updateModelLimit(${providerIndex}, '${modelId}', 'output', parseInt(this.value))">
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 8px;">
                                <label class="form-label" style="font-size: 12px;">è¾“å…¥æ¨¡æ€ (é€—å·åˆ†éš”)</label>
                                <input type="text" class="input" value="${(model.modalities?.input || ['text']).join(', ')}" onchange="updateModelModalities(${providerIndex}, '${modelId}', 'input', this.value)">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label" style="font-size: 12px;">Variants (JSON)</label>
                                <textarea class="input" style="font-family: monospace; font-size: 12px; min-height: 80px;" onchange="updateModelVariants(${providerIndex}, '${modelId}', this.value)">${JSON.stringify(model.variants || {}, null, 2)}</textarea>
                            </div>
                        </div>
                    `).join('') || '<p class="text-muted">æš‚æ— æ¨¡å‹é…ç½®</p>'}
                </div>
                
                <button class="btn" onclick="addModel(${providerIndex})" style="margin-top: 16px;">+ æ·»åŠ æ¨¡å‹</button>
                <button class="btn btn-primary" onclick="saveAllAndBack()" style="margin-top: 16px; margin-left: 8px;">ä¿å­˜å¹¶è¿”å›</button>
            `;
        }

        window.saveAllAndBack = async () => {
            await saveAll();
            backToProviderList();
        };

        window.addModel = (providerIndex) => {
            if (!state.providers[providerIndex].models) {
                state.providers[providerIndex].models = {};
            }
            const modelId = 'new-model-' + Date.now();
            state.providers[providerIndex].models[modelId] = {
                name: '',
                limit: { context: 200000, output: 64000 },
                modalities: { input: ['text'], output: ['text'] },
                variants: {}
            };
            renderModelList(providerIndex);
        };

        window.removeModel = (providerIndex, modelId) => {
            delete state.providers[providerIndex].models[modelId];
            renderModelList(providerIndex);
        };

        window.renameModel = (providerIndex, oldId, newId) => {
            if (oldId !== newId && newId) {
                const provider = state.providers[providerIndex];
                provider.models[newId] = provider.models[oldId];
                delete provider.models[oldId];
                renderModelList(providerIndex);
            }
        };

        window.updateModel = (providerIndex, modelId, field, value) => {
            state.providers[providerIndex].models[modelId][field] = value;
        };

        window.updateModelLimit = (providerIndex, modelId, field, value) => {
            if (!state.providers[providerIndex].models[modelId].limit) {
                state.providers[providerIndex].models[modelId].limit = {};
            }
            state.providers[providerIndex].models[modelId].limit[field] = value;
        };

        window.updateModelModalities = (providerIndex, modelId, type, value) => {
            if (!state.providers[providerIndex].models[modelId].modalities) {
                state.providers[providerIndex].models[modelId].modalities = { input: [], output: [] };
            }
            state.providers[providerIndex].models[modelId].modalities[type] = value.split(',').map(s => s.trim()).filter(Boolean);
        };

        window.updateModelVariants = (providerIndex, modelId, value) => {
            try {
                state.providers[providerIndex].models[modelId].variants = JSON.parse(value);
            } catch (e) {
                // Invalid JSON, ignore
            }
        };

        // --- Image Service Management ---

        async function checkImageSkillStatus() {
            const statusEl = document.getElementById('image-skill-status');
            if (!statusEl) return;
            
            statusEl.innerHTML = '<span style="color: var(--text-muted);">æ­£åœ¨æ£€æµ‹ Skill çŠ¶æ€...</span>';
            
            try {
                const result = await window.api.checkSkillInstalled('image-generator');
                
                if (result && result.installed) {
                    state.imageService.skillInstalled = true;
                    statusEl.innerHTML = '<span style="color: #27ae60;">âœ“ image-generator Skill å·²å®‰è£…</span>';
                } else {
                    state.imageService.skillInstalled = false;
                    statusEl.innerHTML = '<span style="color: #e67e22;">âš  image-generator Skill æœªå®‰è£…</span><br><small class="text-muted">ä¿å­˜é…ç½®åå°†è‡ªåŠ¨å®‰è£…</small>';
                }
            } catch (e) {
                statusEl.innerHTML = '<span style="color: #666;">æ— æ³•æ£€æµ‹ Skill çŠ¶æ€</span>';
            }
        }

        window.saveImageService = async () => {
            state.imageService.url = document.getElementById('image-service-url').value;
            state.imageService.apiKey = document.getElementById('image-service-key').value;
            
            try {
                // Save config
                await window.api.saveConfig({
                    ...state.config,
                    imageService: {
                        url: state.imageService.url,
                        apiKey: state.imageService.apiKey
                    }
                });
                
                // If URL is provided, we should try to install/configure the skill
                if (state.imageService.url) {
                    showToast('æ­£åœ¨é…ç½® image-generator Skill...', 'info');
                    // We assume window.api.installImageGeneratorSkill exists or we implement it via generic command
                    // Since we don't have that specific API exposed in the mock, we'll simulate it or use generic
                    // For now, just save the config is enough as the "Skill" is likely just using this config
                }
                
                showToast('ç”Ÿå›¾æœåŠ¡é…ç½®å·²ä¿å­˜', 'success');
                checkImageSkillStatus();
            } catch (e) {
                showToast('ä¿å­˜å¤±è´¥: ' + e.message, 'error');
            }
        };

        window.selectDashStyle = (id) => {
            state.config.style = id;
            renderOptions();
        };

        // --- FC Config Functions ---
        async function loadFcConfig() {
            try {
                const result = await window.api.getFcConfig();
                if (result.success && result.data) {
                    state.fcAccounts = result.data.accounts || [];
                    renderFcAccounts();
                }
            } catch (e) {
                console.error('Failed to load FC config:', e);
            }
            checkFcSkillStatus();
        }

        async function checkFcSkillStatus() {
            const statusEl = document.getElementById('fc-skill-status');
            if (!statusEl) return;
            try {
                const result = await window.api.checkSkillInstalled('deploy-fc');
                if (result && result.installed) {
                    statusEl.innerHTML = '<span style="color: #27ae60;">âœ“ deploy-fc Skill å·²å®‰è£…</span>';
                } else {
                    statusEl.innerHTML = '<span style="color: #e67e22;">âš  deploy-fc Skill æœªå®‰è£…</span><br><small>ä¿å­˜é…ç½®åå°†è‡ªåŠ¨å®‰è£…</small>';
                }
            } catch (e) {
                statusEl.innerHTML = '<span style="color: #666;">æ— æ³•æ£€æµ‹ Skill çŠ¶æ€</span>';
            }
        }

        function renderFcAccounts() {
            const container = document.getElementById('fc-accounts-list');
            if (!container) return;
            if (state.fcAccounts.length === 0) {
                container.innerHTML = '<p class="text-muted">æš‚æ— é…ç½®çš„è´¦å·ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ </p>';
                return;
            }
            container.innerHTML = state.fcAccounts.map((acc, i) => `
                <div style="border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <strong>${acc.name || 'æœªå‘½åè´¦å·'}</strong>
                        <button class="btn" onclick="removeFcAccount(${i})" style="color: #e74c3c; padding: 4px 8px;">åˆ é™¤</button>
                    </div>
                    <div class="form-group"><label class="form-label">è´¦å·åç§°</label>
                        <input type="text" class="input" value="${acc.name || ''}" onchange="updateFcAccount(${i}, 'name', this.value)"></div>
                    <div class="form-group"><label class="form-label">Account ID</label>
                        <input type="text" class="input" value="${acc.account_id || ''}" onchange="updateFcAccount(${i}, 'account_id', this.value)"></div>
                    <div class="form-group"><label class="form-label">AccessKey ID</label>
                        <input type="text" class="input" value="${acc.access_key_id || ''}" onchange="updateFcAccount(${i}, 'access_key_id', this.value)"></div>
                    <div class="form-group"><label class="form-label">AccessKey Secret</label>
                        <input type="password" class="input" value="${acc.access_key_secret || ''}" onchange="updateFcAccount(${i}, 'access_key_secret', this.value)"></div>
                    <div class="form-group"><label class="form-label">åœ°åŸŸ</label>
                        <select class="select" onchange="updateFcAccount(${i}, 'region', this.value)">
                            <option value="cn-hangzhou" ${acc.region === 'cn-hangzhou' ? 'selected' : ''}>cn-hangzhou</option>
                            <option value="cn-shanghai" ${acc.region === 'cn-shanghai' ? 'selected' : ''}>cn-shanghai</option>
                            <option value="cn-beijing" ${acc.region === 'cn-beijing' ? 'selected' : ''}>cn-beijing</option>
                            <option value="cn-shenzhen" ${acc.region === 'cn-shenzhen' ? 'selected' : ''}>cn-shenzhen</option>
                        </select></div>
                </div>
            `).join('');
        }

        window.addFcAccount = () => {
            state.fcAccounts.push({ name: '', account_id: '', access_key_id: '', access_key_secret: '', region: 'cn-hangzhou' });
            renderFcAccounts();
        };

        window.removeFcAccount = (index) => {
            state.fcAccounts.splice(index, 1);
            renderFcAccounts();
        };

        window.updateFcAccount = (index, field, value) => {
            state.fcAccounts[index][field] = value;
        };

        window.saveFcConfig = async () => {
            try {
                const validAccounts = state.fcAccounts.filter(acc => acc.name || acc.access_key_id);
                await window.api.saveFcConfig({
                    accounts: validAccounts,
                    default_account: validAccounts.length > 0 ? validAccounts[0].name : ''
                });
                showToast('éƒ¨ç½²é…ç½®å·²ä¿å­˜', 'success');
                checkFcSkillStatus();
            } catch (e) {
                showToast('ä¿å­˜å¤±è´¥: ' + e.message, 'error');
            }
        };

        // --- Deploy Tab Management ---
        window.switchDeployTab = (tab) => {
            state.deployTab = tab;
            
            // Update buttons
            document.querySelectorAll('[id^="deploy-tab-"]').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`deploy-tab-${tab}`).classList.add('active');
            
            // Update views
            document.querySelectorAll('[id^="deploy-view-"]').forEach(view => view.classList.add('hidden'));
            document.getElementById(`deploy-view-${tab}`).classList.remove('hidden');
            
            // Load data if needed
            if (tab === 'fc') loadFcConfig();
            if (tab === 'docker') loadDockerConfig();
            if (tab === 'ecs') loadEcsConfig();
        };

        // --- Docker Config Functions ---
        async function loadDockerConfig() {
            try {
                // Try to read from skill config
                const result = await window.api.readSkillConfig('deploy-docker');
                if (result.success && result.data) {
                    state.dockerRegistries = result.data.registries || [];
                    renderDockerRegistries();
                }
            } catch (e) {
                console.error('Failed to load Docker config:', e);
            }
            checkDockerSkillStatus();
        }

        async function checkDockerSkillStatus() {
            const statusEl = document.getElementById('docker-skill-status');
            if (!statusEl) return;
            try {
                const result = await window.api.checkSkillInstalled('deploy-docker');
                if (result && result.installed) {
                    statusEl.innerHTML = '<span style="color: #27ae60;">âœ“ deploy-docker Skill å·²å®‰è£…</span>';
                } else {
                    statusEl.innerHTML = '<span style="color: #e67e22;">âš  deploy-docker Skill æœªå®‰è£…</span><br><small>ä¿å­˜é…ç½®åå°†è‡ªåŠ¨å®‰è£…</small>';
                }
            } catch (e) {
                statusEl.innerHTML = '<span style="color: #666;">æ— æ³•æ£€æµ‹ Skill çŠ¶æ€</span>';
            }
        }

        function renderDockerRegistries() {
            const container = document.getElementById('docker-registries-list');
            if (!container) return;
            if (state.dockerRegistries.length === 0) {
                container.innerHTML = '<p class="text-muted">æš‚æ— é…ç½®çš„ä»“åº“ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ </p>';
                return;
            }
            container.innerHTML = state.dockerRegistries.map((reg, i) => `
                <div style="border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <strong>${reg.name || 'æœªå‘½åä»“åº“'}</strong>
                        <button class="btn" onclick="removeDockerRegistry(${i})" style="color: #e74c3c; padding: 4px 8px;">åˆ é™¤</button>
                    </div>
                    <div class="form-group"><label class="form-label">ä»“åº“åç§° (åˆ«å)</label>
                        <input type="text" class="input" value="${reg.name || ''}" onchange="updateDockerRegistry(${i}, 'name', this.value)" placeholder="ä¾‹å¦‚: my-dockerhub"></div>
                    <div class="form-group"><label class="form-label">Registry URL</label>
                        <input type="text" class="input" value="${reg.registry_url || ''}" onchange="updateDockerRegistry(${i}, 'registry_url', this.value)" placeholder="https://index.docker.io/v1/ æˆ– registry.cn-hangzhou.aliyuncs.com"></div>
                    <div class="form-group"><label class="form-label">å‘½åç©ºé—´ (Namespace)</label>
                        <input type="text" class="input" value="${reg.namespace || ''}" onchange="updateDockerRegistry(${i}, 'namespace', this.value)"></div>
                    <div class="form-group"><label class="form-label">ç”¨æˆ·å</label>
                        <input type="text" class="input" value="${reg.username || ''}" onchange="updateDockerRegistry(${i}, 'username', this.value)"></div>
                    <div class="form-group"><label class="form-label">å¯†ç  / Token</label>
                        <input type="password" class="input" value="${reg.password || ''}" onchange="updateDockerRegistry(${i}, 'password', this.value)"></div>
                </div>
            `).join('');
        }

        window.addDockerRegistry = () => {
            state.dockerRegistries.push({ name: '', registry_url: '', namespace: '', username: '', password: '' });
            renderDockerRegistries();
        };

        window.removeDockerRegistry = (index) => {
            state.dockerRegistries.splice(index, 1);
            renderDockerRegistries();
        };

        window.updateDockerRegistry = (index, field, value) => {
            state.dockerRegistries[index][field] = value;
        };

        window.saveDockerConfig = async () => {
            try {
                const validRegistries = state.dockerRegistries.filter(r => r.name || r.registry_url);
                await window.api.writeSkillConfig('deploy-docker', {
                    registries: validRegistries,
                    default_registry: validRegistries.length > 0 ? validRegistries[0].name : ''
                });
                showToast('Docker é…ç½®å·²ä¿å­˜', 'success');
                checkDockerSkillStatus();
            } catch (e) {
                showToast('ä¿å­˜å¤±è´¥: ' + e.message, 'error');
            }
        };

        // --- ECS Config Functions ---
        async function loadEcsConfig() {
            try {
                const result = await window.api.readSkillConfig('deploy-ecs');
                if (result.success && result.data) {
                    state.ecsServers = result.data.servers || [];
                    renderEcsServers();
                }
            } catch (e) {
                console.error('Failed to load ECS config:', e);
            }
            checkEcsSkillStatus();
        }

        async function checkEcsSkillStatus() {
            const statusEl = document.getElementById('ecs-skill-status');
            if (!statusEl) return;
            try {
                const result = await window.api.checkSkillInstalled('deploy-ecs');
                if (result && result.installed) {
                    statusEl.innerHTML = '<span style="color: #27ae60;">âœ“ deploy-ecs Skill å·²å®‰è£…</span>';
                } else {
                    statusEl.innerHTML = '<span style="color: #e67e22;">âš  deploy-ecs Skill æœªå®‰è£…</span><br><small>ä¿å­˜é…ç½®åå°†è‡ªåŠ¨å®‰è£…</small>';
                }
            } catch (e) {
                statusEl.innerHTML = '<span style="color: #666;">æ— æ³•æ£€æµ‹ Skill çŠ¶æ€</span>';
            }
        }

        function renderEcsServers() {
            const container = document.getElementById('ecs-servers-list');
            if (!container) return;
            if (state.ecsServers.length === 0) {
                container.innerHTML = '<p class="text-muted">æš‚æ— é…ç½®çš„æœåŠ¡å™¨ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ </p>';
                return;
            }
            container.innerHTML = state.ecsServers.map((srv, i) => `
                <div style="border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <strong>${srv.name || 'æœªå‘½åæœåŠ¡å™¨'}</strong>
                        <button class="btn" onclick="removeEcsServer(${i})" style="color: #e74c3c; padding: 4px 8px;">åˆ é™¤</button>
                    </div>
                    <div class="form-group"><label class="form-label">æœåŠ¡å™¨åç§°</label>
                        <input type="text" class="input" value="${srv.name || ''}" onchange="updateEcsServer(${i}, 'name', this.value)" placeholder="ä¾‹å¦‚: prod-server"></div>
                    <div class="form-group"><label class="form-label">ä¸»æœºåœ°å€ (IP/Host)</label>
                        <input type="text" class="input" value="${srv.host || ''}" onchange="updateEcsServer(${i}, 'host', this.value)"></div>
                    <div class="form-group"><label class="form-label">ç«¯å£</label>
                        <input type="number" class="input" value="${srv.port || 22}" onchange="updateEcsServer(${i}, 'port', parseInt(this.value))"></div>
                    <div class="form-group"><label class="form-label">ç”¨æˆ·å</label>
                        <input type="text" class="input" value="${srv.username || 'root'}" onchange="updateEcsServer(${i}, 'username', this.value)"></div>
                    <div class="form-group"><label class="form-label">è®¤è¯æ–¹å¼</label>
                        <select class="select" onchange="updateEcsServer(${i}, 'auth_type', this.value)">
                            <option value="password" ${srv.auth_type === 'password' ? 'selected' : ''}>å¯†ç </option>
                            <option value="key" ${srv.auth_type === 'key' ? 'selected' : ''}>ç§é’¥æ–‡ä»¶</option>
                        </select></div>
                    <div class="form-group"><label class="form-label">å¯†ç  / ç§é’¥è·¯å¾„</label>
                        <input type="password" class="input" value="${srv.password || ''}" onchange="updateEcsServer(${i}, 'password', this.value)" placeholder="${srv.auth_type === 'key' ? '~/.ssh/id_rsa' : 'æœåŠ¡å™¨å¯†ç '}"></div>
                </div>
            `).join('');
        }

        window.addEcsServer = () => {
            state.ecsServers.push({ name: '', host: '', port: 22, username: 'root', auth_type: 'password', password: '' });
            renderEcsServers();
        };

        window.removeEcsServer = (index) => {
            state.ecsServers.splice(index, 1);
            renderEcsServers();
        };

        window.updateEcsServer = (index, field, value) => {
            state.ecsServers[index][field] = value;
        };

        window.saveEcsConfig = async () => {
            try {
                const validServers = state.ecsServers.filter(s => s.name || s.host);
                await window.api.writeSkillConfig('deploy-ecs', {
                    servers: validServers,
                    default_server: validServers.length > 0 ? validServers[0].name : ''
                });
                showToast('ECS é…ç½®å·²ä¿å­˜', 'success');
                checkEcsSkillStatus();
            } catch (e) {
                showToast('ä¿å­˜å¤±è´¥: ' + e.message, 'error');
            }
        };

        // --- SQL Config Functions ---
        async function loadSqlConfig() {
            try {
                const result = await window.api.getSqlConfig();
                if (result.success && result.data) {
                    state.dbConnections = result.data.connections || {};
                    renderDbConnections();
                }
            } catch (e) {
                console.error('Failed to load SQL config:', e);
            }
            checkSqlSkillStatus();
        }

        async function checkSqlSkillStatus() {
            const statusEl = document.getElementById('sql-skill-status');
            if (!statusEl) return;
            try {
                const result = await window.api.checkSkillInstalled('sql-query');
                if (result && result.installed) {
                    statusEl.innerHTML = '<span style="color: #27ae60;">âœ“ sql-query Skill å·²å®‰è£…</span>';
                } else {
                    statusEl.innerHTML = '<span style="color: #e67e22;">âš  sql-query Skill æœªå®‰è£…</span><br><small>ä¿å­˜é…ç½®åå°†è‡ªåŠ¨å®‰è£…</small>';
                }
            } catch (e) {
                statusEl.innerHTML = '<span style="color: #666;">æ— æ³•æ£€æµ‹ Skill çŠ¶æ€</span>';
            }
        }

        function renderDbConnections() {
            const container = document.getElementById('db-connections-list');
            if (!container) return;
            const connections = Object.entries(state.dbConnections);
            if (connections.length === 0) {
                container.innerHTML = '<p class="text-muted">æš‚æ— é…ç½®çš„æ•°æ®åº“è¿æ¥ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ </p>';
                return;
            }
            container.innerHTML = connections.map(([name, conn]) => `
                <div style="border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <strong>${name || 'æœªå‘½å'}</strong>
                        <button class="btn" onclick="removeDbConnection('${name}')" style="color: #e74c3c; padding: 4px 8px;">åˆ é™¤</button>
                    </div>
                    <div class="form-group"><label class="form-label">è¿æ¥åç§°</label>
                        <input type="text" class="input" value="${name}" onchange="renameDbConnection('${name}', this.value)"></div>
                    <div class="form-group"><label class="form-label">ä¸»æœºåœ°å€</label>
                        <input type="text" class="input" value="${conn.host || ''}" onchange="updateDbConnection('${name}', 'host', this.value)"></div>
                    <div class="form-group"><label class="form-label">ç«¯å£</label>
                        <input type="number" class="input" value="${conn.port || 3306}" onchange="updateDbConnection('${name}', 'port', parseInt(this.value))"></div>
                    <div class="form-group"><label class="form-label">ç”¨æˆ·å</label>
                        <input type="text" class="input" value="${conn.user || ''}" onchange="updateDbConnection('${name}', 'user', this.value)"></div>
                    <div class="form-group"><label class="form-label">å¯†ç </label>
                        <input type="password" class="input" value="${conn.password || ''}" onchange="updateDbConnection('${name}', 'password', this.value)"></div>
                    <div class="form-group"><label class="form-label">æ•°æ®åº“å</label>
                        <input type="text" class="input" value="${conn.database || ''}" onchange="updateDbConnection('${name}', 'database', this.value)"></div>
                </div>
            `).join('');
        }

        window.addDbConnection = () => {
            const name = 'connection_' + Date.now();
            state.dbConnections[name] = { host: '', port: 3306, user: '', password: '', database: '' };
            renderDbConnections();
        };

        window.removeDbConnection = (name) => {
            delete state.dbConnections[name];
            renderDbConnections();
        };

        window.renameDbConnection = (oldName, newName) => {
            if (oldName !== newName && newName) {
                state.dbConnections[newName] = state.dbConnections[oldName];
                delete state.dbConnections[oldName];
                renderDbConnections();
            }
        };

        window.updateDbConnection = (name, field, value) => {
            if (state.dbConnections[name]) {
                state.dbConnections[name][field] = value;
            }
        };

        window.saveSqlConfig = async () => {
            try {
                const validConnections = {};
                for (const [name, conn] of Object.entries(state.dbConnections)) {
                    if (conn.host || conn.user) {
                        validConnections[name] = conn;
                    }
                }
                await window.api.saveSqlConfig({ connections: validConnections });
                showToast('æ•°æ®åº“é…ç½®å·²ä¿å­˜', 'success');
                checkSqlSkillStatus();
            } catch (e) {
                showToast('ä¿å­˜å¤±è´¥: ' + e.message, 'error');
            }
        };

        window.saveTab = async (type) => {
            await saveAll();
            showToast('é…ç½®å·²ä¿å­˜');
        };

        window.saveWebhookConfig = async () => {
            const webhookType = document.getElementById('webhook-type').value;
            const webhookUrl = document.getElementById('webhook-url').value;
            const notifyPermission = document.getElementById('notify-permission').checked;
            const notifyIdle = document.getElementById('notify-idle').checked;
            const notifyError = document.getElementById('notify-error').checked;

            if (!webhookUrl) {
                showToast('è¯·è¾“å…¥ Webhook URL');
                return;
            }

            try {
                const result = await window.api.saveWebhookPlugin({
                    type: webhookType,
                    url: webhookUrl,
                    notify_permission: notifyPermission,
                    notify_idle: notifyIdle,
                    notify_error: notifyError
                });

                if (result.success) {
                    showToast('Webhook é…ç½®å·²ä¿å­˜');
                    const statusEl = document.getElementById('webhook-status');
                    statusEl.style.display = 'block';
                    statusEl.innerHTML = '<span style="color: var(--success);">âœ“ æ’ä»¶å·²é…ç½®åˆ° OpenCode</span>';
                } else {
                    showToast('ä¿å­˜å¤±è´¥: ' + result.error);
                }
            } catch (e) {
                showToast('ä¿å­˜å¤±è´¥: ' + e.message);
            }
        };

        window.testWebhook = async () => {
            const webhookUrl = document.getElementById('webhook-url').value;
            const webhookType = document.getElementById('webhook-type').value;

            if (!webhookUrl) {
                showToast('è¯·å…ˆè¾“å…¥ Webhook URL');
                return;
            }

            try {
                const result = await window.api.testWebhook({
                    type: webhookType,
                    url: webhookUrl
                });

                if (result.success) {
                    showToast('æµ‹è¯•é€šçŸ¥å·²å‘é€');
                } else {
                    showToast('å‘é€å¤±è´¥: ' + result.error);
                }
            } catch (e) {
                showToast('å‘é€å¤±è´¥: ' + e.message);
            }
        };

        window.loadWebhookConfig = async () => {
            try {
                const result = await window.api.getWebhookConfig();
                if (result.success && result.data) {
                    const config = result.data;
                    document.getElementById('webhook-type').value = config.type || 'feishu';
                    document.getElementById('webhook-url').value = config.url || '';
                    document.getElementById('notify-permission').checked = config.notify_permission === true;
                    document.getElementById('notify-idle').checked = config.notify_idle === true;
                    document.getElementById('notify-error').checked = config.notify_error === true;
                    
                    if (config.url) {
                        const statusEl = document.getElementById('webhook-status');
                        statusEl.style.display = 'block';
                        statusEl.innerHTML = '<span style="color: var(--success);">âœ“ æ’ä»¶å·²é…ç½®</span>';
                    }
                }
            } catch (e) {
                console.error('Failed to load webhook config:', e);
            }
        };

        async function saveAll() {
            // Save app config (local)
            await window.api.saveConfig(state.config);
            await window.api.saveCredentials(state.credentials);
            
            // Generate and merge prompt_append based on tech stack and design style
            const visualPrompt = generateTechStackPrompt(state.config.frontend, state.config.backend, state.config.style);
            if (visualPrompt) {
                // Write to visual-engineering
                state.promptAppends['visual-engineering'] = mergePromptAppend(
                    state.promptAppends['visual-engineering'] || '', 
                    visualPrompt
                );
                
                // Also write to artistry with image-generator skill
                const artistryPrompt = visualPrompt + `\n\n## å¯ç”¨æŠ€èƒ½\n- ä½¿ç”¨ /ui-ux-pro-max skill è·å–è¯¦ç»†è®¾è®¡æŒ‡å—\n- ä½¿ç”¨ /image-generator skill ç”Ÿæˆåˆ›æ„å›¾ç‰‡ç´ æï¼ˆbannerã€logoã€æ’å›¾ç­‰ï¼‰`;
                state.promptAppends['artistry'] = mergePromptAppend(
                    state.promptAppends['artistry'] || '',
                    artistryPrompt
                );
            }
            
            // Generate and merge prompts for other categories based on backend
            const categoryPrompts = generateCategoryPrompts(state.config.backend);
            for (const [cat, prompt] of Object.entries(categoryPrompts)) {
                if (prompt) {
                    state.promptAppends[cat] = mergePromptAppend(
                        state.promptAppends[cat] || '', 
                        prompt
                    );
                }
            }
            
            // Load existing oh-my-opencode.json and merge updates
            const existingOhMyResult = await window.api.getOhMyOpencodeConfig();
            const ohMyConfig = (existingOhMyResult.success && existingOhMyResult.data) 
                ? existingOhMyResult.data 
                : { "$schema": "https://oh-my-opencode.dev/schema.json", "version": "1.0.0" };
            
            // Remove config-app specific fields if they exist (cleanup)
            delete ohMyConfig.frontend;
            delete ohMyConfig.backend;
            delete ohMyConfig.designStyle;
            
            // Merge categories - preserve existing, update prompt_append
            if (!ohMyConfig.categories) ohMyConfig.categories = {};
            const allCategories = ['visual-engineering', 'ultrabrain', 'quick', 'deep', 'writing', 'artistry', 'unspecified-low', 'unspecified-high'];
            allCategories.forEach(cat => {
                if (!ohMyConfig.categories[cat]) {
                    ohMyConfig.categories[cat] = {};
                }
                // Update prompt_append: use new value if exists, otherwise keep existing
                if (state.promptAppends[cat] !== undefined && state.promptAppends[cat] !== '') {
                    ohMyConfig.categories[cat].prompt_append = state.promptAppends[cat];
                }
            });
            
            await window.api.saveConfigWithBackup('oh-my-opencode', ohMyConfig);
            
            // Build and save real opencode.json with backup (provider config)
            try {
                const existingResult = await window.api.loadAllConfigs();
                const opencodeConfig = (existingResult.success && existingResult.configs && existingResult.configs.opencode) 
                    ? existingResult.configs.opencode 
                    : {};
                
                if (!opencodeConfig.provider) opencodeConfig.provider = {};
                
                // Merge providers - preserve existing fields, only update what we manage
                state.providers.forEach(p => {
                    if (p.name) {
                        const existing = opencodeConfig.provider[p.name] || {};
                        opencodeConfig.provider[p.name] = {
                            ...existing,  // Preserve all existing fields
                            name: p.displayName || existing.name || p.name,
                            npm: p.npm || existing.npm || '@ai-sdk/openai-compatible',
                            options: {
                                ...(existing.options || {}),
                                ...(p.baseUrl ? { baseURL: p.baseUrl } : {}),
                                ...(p.apiKey ? { apiKey: p.apiKey } : {})
                            },
                            models: p.models || existing.models || {}
                        };
                    }
                });
                
                // Add from wizard credentials if set and not empty
                if (state.credentials.proxyName && state.credentials.baseUrl) {
                    const existing = opencodeConfig.provider[state.credentials.proxyName] || {};
                    opencodeConfig.provider[state.credentials.proxyName] = {
                        ...existing,
                        name: state.credentials.displayName || existing.name || state.credentials.proxyName,
                        npm: state.credentials.npm || existing.npm || '@ai-sdk/openai-compatible',
                        options: {
                            ...(existing.options || {}),
                            baseURL: state.credentials.baseUrl,
                            ...(state.credentials.apiKey ? { apiKey: state.credentials.apiKey } : {})
                        },
                        models: existing.models || {}
                    };
                }
                
                await window.api.saveConfigWithBackup('opencode', opencodeConfig);
                
                // Save auth.json - use provider NAME as key, not apiFormat
                const authConfig = (existingResult.success && existingResult.configs && existingResult.configs.auth)
                    ? existingResult.configs.auth
                    : {};
                
                // Add keys from providers - only if apiKey is not empty
                state.providers.forEach(p => {
                    if (p.name && p.apiKey) {
                        authConfig[p.name] = { type: 'api', key: p.apiKey };
                    }
                });
                
                // Add from wizard credentials - only if apiKey is not empty
                if (state.credentials.proxyName && state.credentials.apiKey) {
                    authConfig[state.credentials.proxyName] = { type: 'api', key: state.credentials.apiKey };
                }
                
                await window.api.saveConfigWithBackup('auth', authConfig);
                
            } catch (e) {
                console.error('Error saving provider configs:', e);
                showToast('ä¿å­˜æœåŠ¡å•†é…ç½®å¤±è´¥', 'error');
            }
        }

        // --- New Features ---

        window.installOpencode = async () => {
            const btn = document.getElementById('btn-install-opencode');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'å®‰è£…ä¸­...';
            btn.style.opacity = '0.7';
            
            try {
                await window.api.installOpencode();
                document.getElementById('check-opencode').checked = true;
                btn.textContent = 'âœ“ å®‰è£…æˆåŠŸ';
                btn.style.background = 'var(--success)';
                btn.style.opacity = '1';
                showToast('OpenCode å®‰è£…æˆåŠŸï¼', 'success');
                validateStep();
            } catch (e) {
                btn.disabled = false;
                btn.textContent = originalText;
                btn.style.opacity = '1';
                showToast('å®‰è£…å¤±è´¥: ' + e.message, 'error');
            }
        };

        window.installOhMyOpencode = async () => {
            const btn = document.getElementById('btn-install-omo');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'å®‰è£…ä¸­...';
            btn.style.opacity = '0.7';
            
            try {
                await window.api.installOhMyOpencode();
                btn.textContent = 'å®‰è£…æ’ä»¶ä¸­...';
                // Also install plugins and uiux skill by default
                await window.api.installPlugins();
                btn.textContent = 'å®‰è£… UI/UX Skill...';
                await window.api.installUiuxSkill();
                document.getElementById('check-omo').checked = true;
                btn.textContent = 'âœ“ å®‰è£…æˆåŠŸ';
                btn.style.background = 'var(--success)';
                btn.style.opacity = '1';
                showToast('Oh-My-OpenCode å®‰è£…æˆåŠŸï¼', 'success');
                validateStep();
            } catch (e) {
                btn.disabled = false;
                btn.textContent = originalText;
                btn.style.opacity = '1';
                showToast('å®‰è£…å¤±è´¥: ' + e.message, 'error');
            }
        };

        window.launchOpencode = async (mode) => {
            try {
                await window.api.launchOpencode(mode);
                showToast('OpenCode å·²å¯åŠ¨', 'success');
            } catch (e) {
                showToast('å¯åŠ¨å¤±è´¥: ' + e.message, 'error');
            }
        };

        window.openWebUI = async () => {
            try {
                await window.api.openWebUI();
            } catch (e) {
                showToast('æ‰“å¼€å¤±è´¥: ' + e.message, 'error');
            }
        };

        window.openConfigDir = async () => {
            try {
                await window.api.openConfigDir();
            } catch (e) {
                showToast('æ‰“å¼€å¤±è´¥: ' + e.message, 'error');
            }
        };

        window.loadAgentsMd = async () => {
            try {
                const result = await window.api.readAgentsMd();
                if (result.success) {
                    document.getElementById('agents-md-editor').value = result.data || '';
                } else {
                    // If file doesn't exist, it might be fine, just empty
                    console.log('AGENTS.md not found or empty');
                }
            } catch (e) {
                showToast('åŠ è½½å¤±è´¥: ' + e.message, 'error');
            }
        };

        window.saveAgentsMd = async () => {
            try {
                const content = document.getElementById('agents-md-editor').value;
                await window.api.writeAgentsMd(content);
                showToast('AGENTS.md å·²ä¿å­˜', 'success');
            } catch (e) {
                showToast('ä¿å­˜å¤±è´¥: ' + e.message, 'error');
            }
        };

        function getAvailableModels() {
            const models = [];
            state.providers.forEach(p => {
                if (p.name && p.models) {
                    Object.keys(p.models).forEach(modelId => {
                        models.push({
                            id: `${p.name}/${modelId}`,
                            name: p.models[modelId].name || modelId,
                            provider: p.name,
                            modelId: modelId
                        });
                    });
                }
            });
            return models;
        }

        function getRecommendedModel(categoryType) {
            const models = getAvailableModels();
            if (models.length === 0) return null;
            
            const keywords = modelTypeKeywords[categoryType] || [];
            for (const model of models) {
                const idLower = model.id.toLowerCase();
                if (keywords.some(kw => idLower.includes(kw))) {
                    return model.id;
                }
            }
            return models[0].id;
        }

        function renderCategoryConfig() {
            const container = document.getElementById('category-config-container');
            if (!container) return;
            
            const models = getAvailableModels();
            
            if (models.length === 0) {
                container.innerHTML = `
                    <div style="padding: 20px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                        <p style="color: var(--text-muted);"><svg class="icon" style="color: var(--danger); vertical-align: text-bottom;" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg> è¯·å…ˆåœ¨"æ¨¡å‹æœåŠ¡"é¡µé¢é…ç½®æœåŠ¡å•†å’Œæ¨¡å‹</p>
                    </div>`;
                return;
            }
            
            container.innerHTML = categoryDefinitions.map(cat => {
                const currentModel = state.categoryModels[cat.id] || '';
                const recommended = getRecommendedModel(cat.recommendedType);
                const promptValue = state.promptAppends[cat.id] || '';
                
                return `
                <div style="border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                        <span style="font-size: 20px;">${cat.icon}</span>
                        <strong>${cat.id}</strong>
                        <span style="color: var(--text-muted); font-size: 13px;">(${cat.name})</span>
                    </div>
                    <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 12px;">${cat.description}</p>
                    
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">æ¨¡å‹é€‰æ‹©</label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <select class="select" id="cat-model-${cat.id}" style="flex: 1;" onchange="updateCategoryModel('${cat.id}', this.value)">
                                <option value="">ä½¿ç”¨é»˜è®¤ (${cat.defaultModel})</option>
                                ${models.map(m => `<option value="${m.id}" ${currentModel === m.id ? 'selected' : ''}>${m.id}</option>`).join('')}
                            </select>
                            ${recommended ? `<button class="btn btn-secondary" onclick="setCategoryModel('${cat.id}', '${recommended}')" style="white-space: nowrap;">æ¨è</button>` : ''}
                        </div>
                        ${recommended ? `<div class="form-hint">æ¨è: ${recommended}</div>` : ''}
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">è¿½åŠ æç¤ºè¯ (å¯é€‰)</label>
                        <p class="form-hint" style="margin-top: 0; margin-bottom: 8px;">ä¼šåŸºäºæŠ€æœ¯æ ˆå’Œè®¾è®¡é£æ ¼é€‰æ‹©è‡ªåŠ¨è¡¥å……è¦æ±‚</p>
                        <textarea id="cat-prompt-${cat.id}" rows="2" class="input" style="height: auto;" 
                            onchange="updateCategoryPrompt('${cat.id}', this.value)">${promptValue}</textarea>
                    </div>
                </div>`;
            }).join('');
        }

        window.updateCategoryModel = (catId, value) => {
            state.categoryModels[catId] = value;
        };

        window.setCategoryModel = (catId, value) => {
            state.categoryModels[catId] = value;
            const el = document.getElementById('cat-model-' + catId);
            if (el) el.value = value;
        };

        window.updateCategoryPrompt = (catId, value) => {
            state.promptAppends[catId] = value;
        };

        window.loadCategoryConfig = async () => {
            try {
                const result = await window.api.getOhMyOpencodeConfig();
                if (result.success && result.data && result.data.categories) {
                    for (const [key, value] of Object.entries(result.data.categories)) {
                        if (value.model) state.categoryModels[key] = value.model;
                        if (value.prompt_append) state.promptAppends[key] = value.prompt_append;
                    }
                }
                renderCategoryConfig();
            } catch (e) {
                console.error('Failed to load category config:', e);
                renderCategoryConfig();
            }
        };

        window.saveCategoryConfig = async () => {
            try {
                const result = await window.api.getOhMyOpencodeConfig();
                const config = (result.success && result.data) ? result.data : {};
                
                if (!config.categories) config.categories = {};
                
                categoryDefinitions.forEach(cat => {
                    if (!config.categories[cat.id]) config.categories[cat.id] = {};
                    
                    const model = state.categoryModels[cat.id];
                    if (model) {
                        config.categories[cat.id].model = model;
                    } else {
                        delete config.categories[cat.id].model;
                    }
                    
                    // Only update prompt_append if we have a non-empty value
                    if (state.promptAppends[cat.id]) {
                        config.categories[cat.id].prompt_append = state.promptAppends[cat.id];
                    }
                });
                
                await window.api.saveConfigWithBackup('oh-my-opencode', config);
                showToast('Category é…ç½®å·²ä¿å­˜', 'success');
            } catch (e) {
                showToast('ä¿å­˜å¤±è´¥: ' + e.message, 'error');
            }
        };

        window.loadPromptAppends = window.loadCategoryConfig;
        window.savePromptAppends = window.saveCategoryConfig;

        // --- Utilities ---

        function generateTechStackPrompt(frontend, backend, style) {
            const frontendMap = {
                'react': 'React 18+ (å‡½æ•°ç»„ä»¶ + Hooks)',
                'vue': 'Vue.js 3 (Composition API)',
                'nextjs': 'Next.js 14+ (App Router)',
                'none': ''
            };
            
            const backendMap = {
                'python': 'Python 3.11+ (FastAPI/Flask)',
                'java': 'Java 17+ (Spring Boot)',
                'node': 'Node.js 20+ (Express/Fastify)',
                'none': ''
            };
            
            const styleMap = {
                'glassmorphism': 'ç»ç’ƒæ‹Ÿæ€é£æ ¼ - æ¯›ç»ç’ƒæ•ˆæœ(backdrop-blur)ã€é€æ˜åº¦æ¸å˜ã€æŸ”å’Œé˜´å½±',
                'neumorphism': 'æ–°æ‹Ÿæ€é£æ ¼ - æŸ”å’Œå‡¸èµ·/å‡¹é™·æ•ˆæœã€åŒè‰²ç³»é˜´å½±ã€æç®€å›¾æ ‡',
                'minimalist': 'æç®€ä¸»ä¹‰ - å¤§é‡ç•™ç™½ã€ç®€æ´çº¿æ¡ã€å…‹åˆ¶ç”¨è‰²ã€æ¸…æ™°å±‚æ¬¡',
                'brutalist': 'ç²—é‡ä¸»ä¹‰ - å¤§èƒ†æ’ç‰ˆã€é«˜å¯¹æ¯”åº¦ã€åŸå§‹æ„Ÿã€æ‰“ç ´å¸¸è§„',
                'flat-design': 'æ‰å¹³è®¾è®¡ - çº¯è‰²å—ã€æ— é˜´å½±ã€ç®€æ´å›¾æ ‡ã€æ¸…æ™°è¾¹ç•Œ',
                'material-design': 'Material Design - å¡ç‰‡å¸ƒå±€ã€å¾®å¦™é˜´å½±ã€æ¶Ÿæ¼ªåŠ¨æ•ˆ',
                'dark-mode': 'æ·±è‰²æ¨¡å¼ - æ·±è‰²èƒŒæ™¯ã€æŸ”å’Œå¯¹æ¯”ã€æŠ¤çœ¼é…è‰²',
                'gradient-heavy': 'æ¸å˜é£æ ¼ - ä¸°å¯Œæ¸å˜ã€æµåŠ¨æ„Ÿã€ç°ä»£æ´»åŠ›',
                'cyberpunk': 'èµ›åšæœ‹å…‹ - éœ“è™¹è‰²å½©ã€ç§‘æŠ€æ„Ÿã€æš—è‰²è°ƒã€å‘å…‰æ•ˆæœ',
                'retro-futurism': 'å¤å¤æœªæ¥ - å¤å¤å…ƒç´ ä¸æœªæ¥æ„Ÿç»“åˆã€æ€€æ—§é…è‰²',
                'organic-shapes': 'æœ‰æœºå½¢æ€ - è‡ªç„¶æ›²çº¿ã€æµåŠ¨å½¢çŠ¶ã€æŸ”å’Œè¿‡æ¸¡',
                'swiss-style': 'ç‘å£«é£æ ¼ - ç½‘æ ¼ç³»ç»Ÿã€æ— è¡¬çº¿å­—ä½“ã€å‡ ä½•å›¾å½¢ã€é«˜å¯è¯»æ€§'
            };
            
            let prompt = '## æŠ€æœ¯æ ˆè¦æ±‚\n';
            
            if (frontend && frontend !== 'none' && frontendMap[frontend]) {
                prompt += `- å‰ç«¯æ¡†æ¶ï¼š${frontendMap[frontend]}\n`;
            }
            
            if (backend && backend !== 'none' && backendMap[backend]) {
                prompt += `- åç«¯æ¡†æ¶ï¼š${backendMap[backend]}\n`;
            }
            
            if (style && styleMap[style]) {
                prompt += `\n## è®¾è®¡é£æ ¼è¦æ±‚\n`;
                prompt += `- é£æ ¼ï¼š${styleMap[style]}\n`;
                prompt += `- ä½¿ç”¨ /frontend-ui-ux skill è·å–è¯¦ç»†è®¾è®¡æŒ‡å—\n`;
            }
            
            prompt += `\n## è¯­è¨€è¦æ±‚\n`;
            prompt += `- æ‰€æœ‰æ³¨é‡Šå’Œæ–‡æ¡£å¿…é¡»ä½¿ç”¨ä¸­æ–‡\n`;
            
            return prompt;
        }

        function generateCategoryPrompts(backend) {
            const backendInfo = {
                'python': {
                    name: 'Python 3.11+',
                    framework: 'FastAPI/Flask',
                    testFramework: 'pytest',
                    typeHint: 'ç±»å‹æ³¨è§£ (typing)',
                    patterns: 'Pydantic æ•°æ®éªŒè¯ã€async/await å¼‚æ­¥'
                },
                'java': {
                    name: 'Java 17+',
                    framework: 'Spring Boot',
                    testFramework: 'JUnit 5 + Mockito',
                    typeHint: 'å¼ºç±»å‹',
                    patterns: 'ä¾èµ–æ³¨å…¥ã€AOPã€JPA'
                },
                'node': {
                    name: 'Node.js 20+',
                    framework: 'Express/Fastify',
                    testFramework: 'Jest/Vitest',
                    typeHint: 'TypeScript ç±»å‹',
                    patterns: 'async/awaitã€ä¸­é—´ä»¶æ¨¡å¼'
                },
                'none': null
            };
            
            const info = backendInfo[backend];
            if (!info) return {};
            
            return {
                'ultrabrain': `## åç«¯æŠ€æœ¯æ ˆ
- æ¡†æ¶ï¼š${info.name} (${info.framework})
- æ¨¡å¼ï¼š${info.patterns}

## æ¶æ„è¦æ±‚
- éµå¾ª SOLID åŸåˆ™
- ä½¿ç”¨ä¾èµ–æ³¨å…¥è§£è€¦
- åˆ†å±‚æ¶æ„ï¼ˆController/Service/Repositoryï¼‰
- é”™è¯¯å¤„ç†ç»Ÿä¸€å°è£…

## æµ‹è¯•è¦æ±‚
- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å¿…é¡»æœ‰å•å…ƒæµ‹è¯•
- å¤æ‚æµç¨‹éœ€è¦é›†æˆæµ‹è¯•
- ä½¿ç”¨ ${info.testFramework} æµ‹è¯•æ¡†æ¶
- æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡ 80%+

## è¯­è¨€è¦æ±‚
- æ‰€æœ‰æ³¨é‡Šå’Œæ–‡æ¡£å¿…é¡»ä½¿ç”¨ä¸­æ–‡`,

                'quick': `## åç«¯æŠ€æœ¯æ ˆ
- æ¡†æ¶ï¼š${info.name} (${info.framework})

## ä»£ç è§„èŒƒ
- éµå¾ªé¡¹ç›®ç°æœ‰ä»£ç é£æ ¼
- æ·»åŠ å¿…è¦çš„${info.typeHint}
- å‡½æ•°/æ–¹æ³•æ·»åŠ æ–‡æ¡£æ³¨é‡Š

## æµ‹è¯•è¦æ±‚
- ä¿®æ”¹çš„å‡½æ•°éœ€è¡¥å……å•å…ƒæµ‹è¯•
- ä½¿ç”¨ ${info.testFramework} æµ‹è¯•æ¡†æ¶
- ç¡®ä¿ç°æœ‰æµ‹è¯•é€šè¿‡

## è¯­è¨€è¦æ±‚
- æ‰€æœ‰æ³¨é‡Šå’Œæ–‡æ¡£å¿…é¡»ä½¿ç”¨ä¸­æ–‡`,

                'deep': `## åç«¯æŠ€æœ¯æ ˆ
- æ¡†æ¶ï¼š${info.name} (${info.framework})
- æ¨¡å¼ï¼š${info.patterns}

## ç ”ç©¶æ–¹æ³•
- å…ˆåˆ†æç°æœ‰ä»£ç ç»“æ„å’Œä¾èµ–
- è¯„ä¼°å¤šç§æŠ€æœ¯æ–¹æ¡ˆçš„ä¼˜åŠ£
- è€ƒè™‘æ€§èƒ½ã€å¯ç»´æŠ¤æ€§ã€æ‰©å±•æ€§
- å‚è€ƒä¸šç•Œæœ€ä½³å®è·µ

## æµ‹è¯•è¦æ±‚
- æä¾›å®Œæ•´çš„æµ‹è¯•æ–¹æ¡ˆ
- åŒ…å«å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€è¾¹ç•Œæ¡ä»¶æµ‹è¯•
- ä½¿ç”¨ ${info.testFramework} æµ‹è¯•æ¡†æ¶
- è€ƒè™‘ Mock å’Œæµ‹è¯•æ•°æ®ç®¡ç†

## è¯­è¨€è¦æ±‚
- æ‰€æœ‰æ³¨é‡Šå’Œæ–‡æ¡£å¿…é¡»ä½¿ç”¨ä¸­æ–‡`
            };
        }

        function mergePromptAppend(existing, generated) {
            if (!existing || existing.trim() === '') {
                return generated;
            }
            
            // å®šä¹‰éœ€è¦æ›¿æ¢çš„ç« èŠ‚æ ‡é¢˜
            const sectionsToReplace = [
                '## æŠ€æœ¯æ ˆè¦æ±‚',
                '## æŠ€æœ¯æ ˆæ¨è',
                '## åç«¯æŠ€æœ¯æ ˆ', 
                '## è®¾è®¡é£æ ¼è¦æ±‚',
                '## æ¶æ„è¦æ±‚',
                '## æµ‹è¯•è¦æ±‚',
                '## ä»£ç è§„èŒƒ',
                '## ç ”ç©¶æ–¹æ³•',
                '## è¯­è¨€è¦æ±‚',
                '## å¯ç”¨æŠ€èƒ½'
            ];
            
            let result = existing;
            
            // è§£æç”Ÿæˆçš„å†…å®¹ä¸ºç« èŠ‚
            const generatedSections = {};
            let currentSection = null;
            let currentContent = [];
            
            generated.split('\n').forEach(line => {
                const isHeader = sectionsToReplace.some(h => line.startsWith(h));
                if (isHeader) {
                    if (currentSection) {
                        generatedSections[currentSection] = currentContent.join('\n');
                    }
                    currentSection = line;
                    currentContent = [line];
                } else if (currentSection) {
                    currentContent.push(line);
                }
            });
            if (currentSection) {
                generatedSections[currentSection] = currentContent.join('\n');
            }
            
            // æ›¿æ¢æˆ–è¿½åŠ æ¯ä¸ªç« èŠ‚
            for (const [header, content] of Object.entries(generatedSections)) {
                // æŸ¥æ‰¾ç°æœ‰å†…å®¹ä¸­æ˜¯å¦æœ‰è¿™ä¸ªç« èŠ‚
                const headerRegex = new RegExp(
                    header.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '[\\s\\S]*?(?=\\n## |$)', 
                    'g'
                );
                
                if (result.includes(header)) {
                    // æ›¿æ¢ç°æœ‰ç« èŠ‚
                    result = result.replace(headerRegex, content);
                } else {
                    // è¿½åŠ æ–°ç« èŠ‚
                    result = result.trim() + '\n\n' + content;
                }
            }
            
            return result.trim();
        }

        function showToast(msg) {
            const toast = el('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        let agentModelsData = { agents: {}, categories: {} };
        let availableModels = [];
        let currentAgentModels = {};
        let currentCategoryModels = {};

        async function loadAgentModels() {
            const loading = el('agent-models-loading');
            const content = el('agent-models-content');
            const error = el('agent-models-error');
            
            loading.style.display = 'block';
            content.style.display = 'none';
            error.style.display = 'none';
            
            try {
                const [recsResult, modelsResult, ohMyConfig, compactionResult] = await Promise.all([
                    api.getAgentRecommendations(),
                    api.getAvailableModels(),
                    api.getOhMyOpencodeConfig(),
                    api.getCompactionModel()
                ]);
                
                if (!modelsResult.success || modelsResult.models.length === 0) {
                    loading.style.display = 'none';
                    error.style.display = 'block';
                    return;
                }
                
                agentModelsData = recsResult;
                availableModels = modelsResult.models;
                
                // Reset current models
                currentAgentModels = {};
                currentCategoryModels = {};
                
                // Load existing values from config
                if (ohMyConfig.success && ohMyConfig.data) {
                    const agents = ohMyConfig.data.agents || {};
                    const categories = ohMyConfig.data.categories || {};
                    
                    // Load agent models
                    for (const [k, v] of Object.entries(agents)) {
                        if (v.model) currentAgentModels[k] = v.model;
                    }
                    
                    // Load category models and prompt_appends
                    for (const [k, v] of Object.entries(categories)) {
                        if (v.model) currentCategoryModels[k] = v.model;
                        if (v.prompt_append) state.promptAppends[k] = v.prompt_append;
                    }
                }
                
                // Load compaction model from opencode.json (separate config target)
                if (compactionResult && compactionResult.success && compactionResult.model) {
                    currentAgentModels['compaction'] = compactionResult.model;
                }
                
                // Auto-match models for any missing entries
                autoMatchModels();
                
                renderAgentModels();
                loading.style.display = 'none';
                content.style.display = 'block';
            } catch (e) {
                loading.style.display = 'none';
                error.style.display = 'block';
                error.innerHTML = '<p><svg class="icon" style="color: var(--danger); vertical-align: text-bottom;" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg> åŠ è½½å¤±è´¥: ' + e.message + '</p>';
            }
        }

        function renderAgentModels() {
            const agentList = el('agent-models-list');
            const categoryList = el('category-models-list');
            
            agentList.innerHTML = '';
            categoryList.innerHTML = '';
            
            for (const [id, info] of Object.entries(agentModelsData.agents)) {
                agentList.appendChild(createModelSelector('agent', id, info, currentAgentModels[id]));
            }
            
            for (const [id, info] of Object.entries(agentModelsData.categories)) {
                categoryList.appendChild(createModelSelector('category', id, info, currentCategoryModels[id]));
            }
        }

        function createModelSelector(type, id, info, currentModel) {
            const div = document.createElement('div');
            div.style.cssText = 'padding: 12px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border); margin-bottom: 8px;';
            
            const topRow = document.createElement('div');
            topRow.style.cssText = 'display: flex; align-items: center; gap: 12px;';
            
            const labelDiv = document.createElement('div');
            labelDiv.style.cssText = 'flex: 1; min-width: 200px;';
            const targetHint = info.target ? ' <span style="font-size: 11px; padding: 1px 6px; background: var(--warning); color: #fff; border-radius: 4px; font-weight: 400;">â†’ ' + info.target + '</span>' : '';
            labelDiv.innerHTML = '<div style="font-weight: 500; color: var(--text-primary);">' + info.name + targetHint + '</div>' +
                '<div style="font-size: 12px; color: var(--text-muted);">' + info.role + '</div>';
            
            const select = document.createElement('select');
            select.className = 'input';
            select.style.cssText = 'flex: 2; max-width: 400px;';
            select.id = type + '-model-' + id;
            
            // Add placeholder option
            const placeholderOpt = document.createElement('option');
            placeholderOpt.value = '';
            placeholderOpt.textContent = '-- è¯·é€‰æ‹©æ¨¡å‹ --';
            if (!currentModel) placeholderOpt.selected = true;
            select.appendChild(placeholderOpt);
            
            availableModels.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.id;
                opt.textContent = m.name + ' (' + m.provider + ')';
                if (m.id === currentModel) opt.selected = true;
                select.appendChild(opt);
            });
            
            select.onchange = () => {
                if (type === 'agent') {
                    currentAgentModels[id] = select.value;
                } else {
                    currentCategoryModels[id] = select.value;
                }
            };
            
            topRow.appendChild(labelDiv);
            topRow.appendChild(select);
            div.appendChild(topRow);
            
            if (type === 'category') {
                const promptRow = document.createElement('div');
                promptRow.style.cssText = 'margin-top: 8px;';
                
                const promptLabel = document.createElement('label');
                promptLabel.style.cssText = 'display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 4px;';
                promptLabel.textContent = 'è¿½åŠ æç¤ºè¯ (å¯é€‰)';
                
                const textarea = document.createElement('textarea');
                textarea.className = 'input';
                textarea.style.cssText = 'width: 100%; height: 60px; resize: vertical;';
                textarea.id = 'category-prompt-' + id;
                textarea.value = state.promptAppends[id] || '';
                textarea.onchange = () => { state.promptAppends[id] = textarea.value; };
                
                promptRow.appendChild(promptLabel);
                promptRow.appendChild(textarea);
                div.appendChild(promptRow);
            }
            
            return div;
        }

        function autoMatchModels() {
            // Provider priority: hosted first, then others
            const providerPriority = ['hosted'];
            availableModels.forEach(m => {
                if (m.provider && !providerPriority.includes(m.provider)) {
                    providerPriority.push(m.provider);
                }
            });
            
            // Check if a model exists in availableModels
            function modelExists(modelId) {
                return availableModels.some(m => m.id === modelId);
            }
            
            // Pattern mapping for model keywords
            const patterns = {
                opus: /opus|claude.*4.*5.*20251101/i,
                sonnet: /sonnet|claude.*4.*5(?!.*20251101)|claude-sonnet-4/i,
                haiku: /haiku/i,
                gemini_pro: /gemini.*pro|gemini-2.*pro|gemini-3.*pro/i,
                gemini_flash: /gemini.*flash|gemini-2.*flash|gemini-3.*flash/i,
                gpt4: /gpt-4\.1(?!.*mini)|gpt-4o(?!.*mini)|gpt-5/i,
                gpt4_mini: /gpt-4\.1-mini|gpt-4o-mini/i,
                codex: /codex|o3|o1-pro/i,
                o1: /o1(?!.*mini)/i,
                o3: /o3/i,
                deepseek: /deepseek-chat|deepseek-v3/i,
                deepseek_reasoner: /deepseek-reasoner|deepseek-r1/i
            };
            
            // Build matched models map with provider priority
            const matched = {};
            for (const [cat, pattern] of Object.entries(patterns)) {
                // Find best match respecting provider priority
                for (const provider of providerPriority) {
                    const found = availableModels.find(m => 
                        m.provider === provider && (pattern.test(m.id) || pattern.test(m.name))
                    );
                    if (found) {
                        matched[cat] = found.id;
                        break;
                    }
                }
                // If not found in priority providers, try any
                if (!matched[cat]) {
                    const found = availableModels.find(m => pattern.test(m.id) || pattern.test(m.name));
                    if (found) matched[cat] = found.id;
                }
            }
            
            // Helper: find best model based on prefer array
            function findBestModel(preferList) {
                if (!preferList || preferList.length === 0) return null;
                for (const pref of preferList) {
                    if (matched[pref]) return matched[pref];
                }
                return null;
            }
            
            // Fallback tier mapping (if prefer doesn't match)
            const tierToModel = {
                primary: matched.opus || matched.sonnet || matched.gpt4 || matched.deepseek || (availableModels[0] && availableModels[0].id),
                reasoning: matched.codex || matched.o3 || matched.o1 || matched.deepseek_reasoner || matched.opus || matched.gpt4 || matched.sonnet,
                fast: matched.haiku || matched.gemini_flash || matched.gpt4_mini || matched.sonnet,
                multimodal: matched.gemini_pro || matched.gemini_flash || matched.sonnet || matched.opus,
                secondary: matched.sonnet || matched.gpt4_mini || matched.gemini_pro || matched.deepseek
            };
            
            // Match agents - check if current model exists, if not re-match
            for (const [id, info] of Object.entries(agentModelsData.agents)) {
                if (!currentAgentModels[id] || !modelExists(currentAgentModels[id])) {
                    const preferMatch = findBestModel(info.prefer);
                    currentAgentModels[id] = preferMatch || tierToModel[info.tier] || tierToModel.primary || '';
                }
            }
            
            // Match categories - check if current model exists, if not re-match
            for (const [id, info] of Object.entries(agentModelsData.categories)) {
                if (!currentCategoryModels[id] || !modelExists(currentCategoryModels[id])) {
                    const preferMatch = findBestModel(info.prefer);
                    currentCategoryModels[id] = preferMatch || tierToModel[info.tier] || tierToModel.primary || '';
                }
            }
        }

        async function saveAgentModels() {
            try {
                // Build complete config structure
                const omoResult = await window.api.getOhMyOpencodeConfig();
                const config = (omoResult.success && omoResult.data) ? { ...omoResult.data } : {};
                
                // Ensure schema
                if (!config.$schema) {
                    config.$schema = "https://raw.githubusercontent.com/code-yeongyu/oh-my-opencode/master/assets/oh-my-opencode.schema.json";
                }
                
                // Build agents section (skip compaction â€” it goes to opencode.json)
                if (!config.agents) config.agents = {};
                for (const [id, model] of Object.entries(currentAgentModels)) {
                    if (id === 'compaction') continue;  // handled separately below
                    if (model) {  // Only save if model is selected
                        if (!config.agents[id]) config.agents[id] = {};
                        config.agents[id].model = model;
                    }
                }
                
                // Build categories section
                if (!config.categories) config.categories = {};
                for (const [id, model] of Object.entries(currentCategoryModels)) {
                    if (model) {  // Only save if model is selected
                        if (!config.categories[id]) config.categories[id] = {};
                        config.categories[id].model = model;
                    }
                    // Update prompt_append if we have a value
                    if (state.promptAppends[id]) {
                        if (!config.categories[id]) config.categories[id] = {};
                        config.categories[id].prompt_append = state.promptAppends[id];
                    }
                }
                
                await window.api.saveConfigWithBackup('oh-my-opencode', config);
                
                // Save compaction model to opencode.json (separate config target)
                const compactionModel = currentAgentModels['compaction'] || '';
                await window.api.saveCompactionModel(compactionModel || null);
                
                showToast('æ¨¡å‹é…ç½®å·²ä¿å­˜');
            } catch (e) {
                showToast('ä¿å­˜å¤±è´¥: ' + e.message);
            }
        }

        function resetToRecommendedModels() {
            // Clear current selections
            currentAgentModels = {};
            currentCategoryModels = {};
            
            // Re-run auto-match to get recommended models
            autoMatchModels();
            
            // Re-render the UI
            renderAgentModels();
            
            showToast('å·²é‡ç½®ä¸ºæ¨èæ¨¡å‹é…ç½®');
        }

        function switchModelTab(tab) {
            // Update tab buttons
            document.getElementById('model-tab-agents').style.borderBottomColor = tab === 'agents' ? 'var(--accent)' : 'transparent';
            document.getElementById('model-tab-agents').style.color = tab === 'agents' ? 'var(--text-primary)' : 'var(--text-muted)';
            document.getElementById('model-tab-categories').style.borderBottomColor = tab === 'categories' ? 'var(--accent)' : 'transparent';
            document.getElementById('model-tab-categories').style.color = tab === 'categories' ? 'var(--text-primary)' : 'var(--text-muted)';
            
            // Update tab content
            document.getElementById('model-tab-content-agents').style.display = tab === 'agents' ? 'block' : 'none';
            document.getElementById('model-tab-content-categories').style.display = tab === 'categories' ? 'block' : 'none';
        }

        function toggleCollapsible(sectionId) {
            const content = document.getElementById(sectionId);
            const icon = document.getElementById(sectionId + '-icon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        async function loadBackupList() {
            const container = document.getElementById('backup-list');
            if (!container) return;
            
            try {
                const result = await window.api.listBackups();
                if (!result.success || !result.backups || result.backups.length === 0) {
                    container.innerHTML = '<p class="text-muted">æš‚æ— å¤‡ä»½è®°å½•</p>';
                    return;
                }
                
                const configTypes = {
                    'opencode': 'OpenCode é…ç½®',
                    'oh-my-opencode': 'Oh-My-OpenCode é…ç½®',
                    'oh': 'Oh-My-OpenCode é…ç½®',
                    'auth': 'è®¤è¯é…ç½®'
                };
                
                container.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>é…ç½®ç±»å‹</th>
                                <th>å¤‡ä»½æ—¶é—´</th>
                                <th style="text-align: right;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${result.backups.map(b => {
                                const parts = b.name.split('-');
                                const type = parts[0];
                                const typeName = configTypes[type] || type;
                                const time = new Date(b.time).toLocaleString('zh-CN');
                                return `
                                    <tr>
                                        <td>${typeName}</td>
                                        <td>${time}</td>
                                        <td class="table-actions">
                                            <button class="btn btn-ghost btn-sm" onclick="previewBackup('${b.name}')">é¢„è§ˆ</button>
                                            <button class="btn btn-ghost btn-sm" onclick="restoreBackup('${b.name}')" style="color: var(--accent);">è¿˜åŸ</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (e) {
                container.innerHTML = '<p class="text-muted">åŠ è½½å¤‡ä»½åˆ—è¡¨å¤±è´¥: ' + e.message + '</p>';
            }
        }

        window.createManualBackup = async () => {
            try {
                showToast('æ­£åœ¨åˆ›å»ºå¤‡ä»½...', 'info');
                
                const opencodeResult = await window.api.getOpencodeConfig();
                if (opencodeResult.success && opencodeResult.data) {
                    await window.api.saveConfigWithBackup('opencode', opencodeResult.data);
                }
                
                const omoResult = await window.api.getOhMyOpencodeConfig();
                if (omoResult.success && omoResult.data) {
                    await window.api.saveConfigWithBackup('oh-my-opencode', omoResult.data);
                }
                
                showToast('å¤‡ä»½åˆ›å»ºæˆåŠŸ', 'success');
                loadBackupList();
            } catch (e) {
                showToast('å¤‡ä»½å¤±è´¥: ' + e.message, 'error');
            }
        };

        window.previewBackup = async (backupName) => {
            try {
                const configDir = await window.api.getConfigDir();
                const backupPath = configDir + '/backups/' + backupName;
                showToast('å¤‡ä»½æ–‡ä»¶: ' + backupPath, 'info');
            } catch (e) {
                showToast('é¢„è§ˆå¤±è´¥: ' + e.message, 'error');
            }
        };

        window.restoreBackup = async (backupName) => {
            if (!confirm('ç¡®å®šè¦è¿˜åŸæ­¤å¤‡ä»½å—ï¼Ÿå½“å‰é…ç½®å°†è¢«è¦†ç›–ã€‚')) {
                return;
            }
            
            try {
                const result = await window.api.restoreBackup(backupName);
                if (result.success) {
                    showToast('è¿˜åŸæˆåŠŸï¼Œè¯·é‡å¯åº”ç”¨ä»¥ç”Ÿæ•ˆ', 'success');
                } else {
                    showToast('è¿˜åŸå¤±è´¥: ' + result.error, 'error');
                }
            } catch (e) {
                showToast('è¿˜åŸå¤±è´¥: ' + e.message, 'error');
            }
        };

        // ==================== Auto Update ====================
        let updateInfo = null;

        function initUpdater() {
            if (!window.updater) return;

            window.updater.onUpdateAvailable((info) => {
                updateInfo = info;
                showUpdateBanner(info.version);
            });

            window.updater.onUpdateDownloaded((info) => {
                hideUpdateBanner();
                showUpdateReadyModal(info.version);
            });

            window.updater.onUpdaterStatus((status) => {
                if (status.event === 'download-progress') {
                    updateDownloadProgress(status.data.percent);
                } else if (status.event === 'update-error') {
                    showToast('æ›´æ–°å¤±è´¥: ' + status.data.message, 'error');
                    resetUpdateBanner();
                }
            });

            window.updater.getVersion().then(version => {
                const versionEl = document.getElementById('app-version');
                if (versionEl) versionEl.textContent = 'v' + version;
            });
        }

        function showUpdateBanner(version) {
            const banner = document.getElementById('update-banner');
            const versionEl = document.getElementById('update-version');
            if (banner && versionEl) {
                versionEl.textContent = 'v' + version;
                banner.classList.remove('hidden');
                document.body.classList.add('has-update-banner');
            }
        }

        function hideUpdateBanner() {
            const banner = document.getElementById('update-banner');
            if (banner) {
                banner.classList.add('hidden');
                document.body.classList.remove('has-update-banner');
            }
        }

        function dismissUpdate() {
            hideUpdateBanner();
        }

        async function downloadUpdate() {
            const btn = document.getElementById('btn-download-update');
            const progressEl = document.getElementById('update-progress');
            
            if (btn) btn.disabled = true;
            if (progressEl) progressEl.classList.remove('hidden');
            
            try {
                const result = await window.updater.downloadUpdate();
                if (!result.success) {
                    showToast('ä¸‹è½½å¤±è´¥: ' + result.error, 'error');
                    resetUpdateBanner();
                }
            } catch (e) {
                showToast('ä¸‹è½½å¤±è´¥: ' + e.message, 'error');
                resetUpdateBanner();
            }
        }

        function updateDownloadProgress(percent) {
            const fill = document.getElementById('progress-fill');
            const text = document.getElementById('progress-text');
            if (fill) fill.style.width = percent + '%';
            if (text) text.textContent = Math.round(percent) + '%';
        }

        function resetUpdateBanner() {
            const btn = document.getElementById('btn-download-update');
            const progressEl = document.getElementById('update-progress');
            if (btn) btn.disabled = false;
            if (progressEl) progressEl.classList.add('hidden');
            updateDownloadProgress(0);
        }

        function showUpdateReadyModal(version) {
            const modal = document.getElementById('update-ready-modal');
            const versionEl = document.getElementById('ready-version');
            if (modal && versionEl) {
                versionEl.textContent = 'v' + version;
                modal.classList.remove('hidden');
            }
        }

        function closeUpdateModal() {
            const modal = document.getElementById('update-ready-modal');
            if (modal) modal.classList.add('hidden');
        }

        function installUpdate() {
            window.updater.installUpdate();
        }

        window.checkForUpdates = async () => {
            showToast('æ­£åœ¨æ£€æŸ¥æ›´æ–°...', 'info');
            try {
                const result = await window.updater.checkForUpdates();
                if (result.success) {
                    if (result.updateAvailable) {
                        showToast('å‘ç°æ–°ç‰ˆæœ¬ v' + result.version, 'success');
                    } else {
                        showToast('å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬', 'success');
                    }
                } else {
                    showToast('æ£€æŸ¥æ›´æ–°å¤±è´¥: ' + result.error, 'error');
                }
            } catch (e) {
                showToast('æ£€æŸ¥æ›´æ–°å¤±è´¥: ' + e.message, 'error');
            }
        };


        // ==================== User Center ====================
        let ucState = {
            loggedIn: false,
            user: null,
            tokens: [],
            selectedPlan: 'free',
            config: null,
            logs: [],
            currentPage: 1,
            totalPages: 1,
            pageSize: 10,
            lastUsername: localStorage.getItem('uc_last_username') || ''
        };

        async function loadUserCenter() {
            // å¦‚æœå·²ç»ç™»å½•ï¼Œç›´æ¥æ˜¾ç¤ºå·²ç™»å½•ç•Œé¢
            if (ucState.loggedIn && ucState.user) {
                showLoggedIn();
                return;
            }
            
            try {
                const configResult = await window.api.hostedGetConfig();
                if (configResult.success) {
                    ucState.config = configResult.data;
                    ucState.selectedPlan = configResult.data.plan || 'free';
                    if (configResult.data.username) {
                        ucState.lastUsername = configResult.data.username;
                    }
                }
                if (ucState.config && ucState.config.enabled) {
                    const userResult = await window.api.hostedGetCurrentUser();
                    if (userResult.success && userResult.data && userResult.data.data) {
                        const remoteUser = userResult.data.data;
                        if (ucState.config.username && remoteUser.username !== ucState.config.username) {
                            console.log('[user-center] Session user mismatch, clearing local state');
                            ucState.config.enabled = false;
                            await window.api.hostedSaveConfig({ enabled: false });
                            await window.api.hostedLogout();
                            showNotLoggedIn();
                            return;
                        }
                        ucState.loggedIn = true;
                        ucState.user = remoteUser;
                        ucState.lastUsername = ucState.user.username;
                        localStorage.setItem('uc_last_username', ucState.lastUsername);
                        showLoggedIn();
                        return;
                    }
                }
                showNotLoggedIn();
            } catch (e) {
                console.error('Failed to load user center:', e);
                showNotLoggedIn();
            }
        }

        function showNotLoggedIn() {
            ucState.loggedIn = false;
            el('uc-not-logged-in').classList.remove('hidden');
            el('uc-logged-in').classList.add('hidden');
            
            if (ucState.lastUsername) {
                el('uc-login-username').value = ucState.lastUsername;
                el('uc-form-register').classList.add('hidden');
                el('uc-form-login').classList.remove('hidden');
                el('uc-switch-account-link').classList.add('hidden');
                el('uc-use-other-link').classList.remove('hidden');
            } else {
                el('uc-form-register').classList.remove('hidden');
                el('uc-form-login').classList.add('hidden');
            }
        }

        function switchToLogin() {
            el('uc-form-register').classList.add('hidden');
            el('uc-form-login').classList.remove('hidden');
            el('uc-switch-account-link').classList.remove('hidden');
            el('uc-use-other-link').classList.add('hidden');
            el('uc-login-username').value = '';
            el('uc-login-password').value = '';
        }

        function switchToRegister() {
            el('uc-form-login').classList.add('hidden');
            el('uc-form-register').classList.remove('hidden');
            el('uc-reg-username').value = '';
            el('uc-reg-email').value = '';
            el('uc-reg-code').value = '';
            el('uc-reg-password').value = '';
        }

        let verificationCodeCountdown = 0;
        async function sendVerificationCode() {
            const email = el('uc-reg-email').value.trim();
            if (!email) {
                showToast('è¯·å…ˆè¾“å…¥é‚®ç®±');
                return;
            }
            if (verificationCodeCountdown > 0) {
                return;
            }
            
            const btn = el('uc-send-code-btn');
            btn.disabled = true;
            btn.textContent = 'å‘é€ä¸­...';
            
            try {
                const result = await window.api.hostedSendVerificationCode(email);
                if (result.success) {
                    showToast('éªŒè¯ç å·²å‘é€ï¼Œè¯·æŸ¥æ”¶é‚®ç®±');
                    verificationCodeCountdown = 60;
                    const timer = setInterval(() => {
                        verificationCodeCountdown--;
                        if (verificationCodeCountdown <= 0) {
                            clearInterval(timer);
                            btn.disabled = false;
                            btn.textContent = 'å‘é€éªŒè¯ç ';
                        } else {
                            btn.textContent = verificationCodeCountdown + 's';
                        }
                    }, 1000);
                } else {
                    showToast('å‘é€å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                    btn.disabled = false;
                    btn.textContent = 'å‘é€éªŒè¯ç ';
                }
            } catch (e) {
                showToast('å‘é€å¤±è´¥: ' + e.message);
                btn.disabled = false;
                btn.textContent = 'å‘é€éªŒè¯ç ';
            }
        }

        async function showLoggedIn() {
            el('uc-not-logged-in').classList.add('hidden');
            el('uc-logged-in').classList.remove('hidden');
            if (ucState.user) {
                el('uc-username').textContent = ucState.user.username || '';
                el('uc-balance').textContent = '$' + ((ucState.user.quota || 0) / 500000).toFixed(2);
                el('uc-used-quota').textContent = '$' + ((ucState.user.used_quota || 0) / 500000).toFixed(2);
                el('uc-total-requests').textContent = (ucState.user.request_count || 0).toLocaleString();
                el('uc-aff-count').textContent = (ucState.user.aff_count || 0).toLocaleString();
                el('uc-aff-quota').textContent = '$' + ((ucState.user.aff_quota || 0) / 500000).toFixed(2);
                
                // æ›´æ–°é‚€è¯·é“¾æ¥
                var affCode = ucState.user.aff_code || '';
                el('uc-invite-link').value = affCode ? 'http://8.153.201.122:3000/register?aff=' + affCode : '';
            }
            updatePlanSelection();
            await loadTokens();
            await refreshLogs();
            await loadUsageChart();
            updateConfigStatus();
        }

        async function loadUsageChart() {
            try {
                // è·å–æœ€è¿‘7å¤©çš„æ•°æ®
                const now = Math.floor(Date.now() / 1000);
                const sevenDaysAgo = now - 7 * 24 * 60 * 60;
                const result = await window.api.hostedGetStatistics(sevenDaysAgo, now);
                
                if (result.success && result.data && result.data.data) {
                    renderUsageChart(result.data.data);
                } else {
                    showEmptyChart();
                }
            } catch (e) {
                console.error('Failed to load usage chart:', e);
                showEmptyChart();
            }
        }

        function renderUsageChart(data) {
            const barsContainer = el('usage-chart-bars');
            const labelsContainer = el('usage-chart-labels');
            const emptyEl = el('usage-chart-empty');
            
            if (!data || data.length === 0) {
                showEmptyChart();
                return;
            }
            
            emptyEl.style.display = 'none';
            
            // æŒ‰æ—¥æœŸåˆ†ç»„ç»Ÿè®¡
            const dailyData = {};
            const today = new Date();
            
            // åˆå§‹åŒ–æœ€è¿‘7å¤©
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const key = date.toISOString().split('T')[0];
                dailyData[key] = 0;
            }
            
            // ç´¯åŠ æ•°æ®
            data.forEach(item => {
                if (item.created_at) {
                    const date = new Date(item.created_at * 1000).toISOString().split('T')[0];
                    if (dailyData.hasOwnProperty(date)) {
                        dailyData[date] += (item.quota || 0);
                    }
                }
            });
            
            const values = Object.values(dailyData);
            const maxValue = Math.max(...values, 1);
            
            // æ¸²æŸ“æŸ±çŠ¶å›¾
            let barsHtml = '';
            let labelsHtml = '';
            
            Object.entries(dailyData).forEach(([date, value]) => {
                const height = Math.max((value / maxValue) * 80, 2);
                const displayValue = (value / 500000).toFixed(2);
                const dayLabel = date.slice(5).replace('-', '/');
                
                barsHtml += '<div style="display: flex; flex-direction: column; align-items: center; flex: 1;">';
                barsHtml += '<div style="font-size: 10px; color: var(--text-muted); margin-bottom: 4px;">$' + displayValue + '</div>';
                barsHtml += '<div style="width: 24px; height: ' + height + 'px; background: var(--accent); border-radius: 2px;"></div>';
                barsHtml += '</div>';
                
                labelsHtml += '<span>' + dayLabel + '</span>';
            });
            
            barsContainer.innerHTML = barsHtml;
            labelsContainer.innerHTML = labelsHtml;
        }

        function showEmptyChart() {
            el('usage-chart-bars').innerHTML = '';
            el('usage-chart-labels').innerHTML = '';
            el('usage-chart-empty').style.display = 'block';
        }

        const HOSTED_TOKEN_NAME = 'superopencode';

        async function ensureHostedToken() {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ superopencode å¯†é’¥
            try {
                const tokensResult = await window.api.hostedGetTokens(1, 50);
                if (tokensResult.success && tokensResult.data && tokensResult.data.data) {
                    const tokens = tokensResult.data.data.items || [];
                    const existingToken = tokens.find(t => t.name === HOSTED_TOKEN_NAME);
                    
                    if (existingToken && existingToken.key) {
                        // å·²å­˜åœ¨ï¼Œç›´æ¥ä½¿ç”¨
                        return existingToken.key;
                    }
                }
                
                // ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°å¯†é’¥
                const createResult = await window.api.hostedCreateToken(HOSTED_TOKEN_NAME, 500000, false, -1);
                if (createResult.success && createResult.data && createResult.data.data) {
                    return createResult.data.data.key;
                }
                
                return null;
            } catch (e) {
                console.error('Failed to ensure hosted token:', e);
                return null;
            }
        }

        async function autoConfigureHostedService() {
            showToast('æ­£åœ¨é…ç½®æ‰˜ç®¡æœåŠ¡...', 'info');
            
            // 1. ç¡®ä¿æœ‰ superopencode å¯†é’¥
            const apiKey = await ensureHostedToken();
            if (!apiKey) {
                showToast('åˆ›å»ºå¯†é’¥å¤±è´¥', 'error');
                return false;
            }
            
            // 2. åº”ç”¨é…ç½®åˆ° opencode
            try {
                const result = await window.api.hostedApplyConfig(apiKey, ucState.selectedPlan || 'free');
                if (result.success) {
                    ucState.config = Object.assign({}, ucState.config, { 
                        apiKey: apiKey, 
                        plan: ucState.selectedPlan || 'free', 
                        enabled: true 
                    });
                    showToast('æ‰˜ç®¡æœåŠ¡å·²è‡ªåŠ¨é…ç½®', 'success');
                    return true;
                } else {
                    showToast('é…ç½®å¤±è´¥: ' + result.error, 'error');
                    return false;
                }
            } catch (e) {
                showToast('é…ç½®å¤±è´¥: ' + e.message, 'error');
                return false;
            }
        }

        async function doLogin() {
            const username = el('uc-login-username').value.trim();
            const password = el('uc-login-password').value;
            if (!username || !password) { showToast('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç '); return; }
            try {
                const result = await window.api.hostedLogin(username, password);
                if (result.success) {
                    showToast('ç™»å½•æˆåŠŸ');
                    ucState.loggedIn = true;
                    ucState.lastUsername = username;
                    localStorage.setItem('uc_last_username', username);
                    await window.api.hostedSaveConfig({ username: username });
                    const userResult = await window.api.hostedGetCurrentUser();
                    if (userResult.success && userResult.data && userResult.data.data) {
                        ucState.user = userResult.data.data;
                    }
                    
                    // è‡ªåŠ¨é…ç½®æ‰˜ç®¡æœåŠ¡
                    await autoConfigureHostedService();
                    
                    showLoggedIn();
                } else { showToast('ç™»å½•å¤±è´¥: ' + result.error); }
            } catch (e) { showToast('ç™»å½•å¤±è´¥: ' + e.message); }
        }

        async function doRegister() {
            const username = el('uc-reg-username').value.trim();
            const email = el('uc-reg-email').value.trim();
            const verificationCode = el('uc-reg-code').value.trim();
            const password = el('uc-reg-password').value;
            if (!username || !email || !password) { showToast('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹'); return; }
            if (!verificationCode) { showToast('è¯·è¾“å…¥é‚®ç®±éªŒè¯ç '); return; }
            if (password.length < 8) { showToast('å¯†ç è‡³å°‘éœ€è¦8ä½'); return; }
            try {
                const result = await window.api.hostedRegister(username, password, email, verificationCode, '');
                if (result.success) {
                    showToast('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•');
                    ucState.lastUsername = username;
                    localStorage.setItem('uc_last_username', username);
                    el('uc-form-register').classList.add('hidden');
                    el('uc-form-login').classList.remove('hidden');
                    el('uc-login-username').value = username;
                    el('uc-login-password').value = '';
                    el('uc-switch-account-link').classList.add('hidden');
                    el('uc-use-other-link').classList.remove('hidden');
                } else { showToast('æ³¨å†Œå¤±è´¥: ' + result.error); }
            } catch (e) { showToast('æ³¨å†Œå¤±è´¥: ' + e.message); }
        }

        async function doLogout() {
            try {
                await window.api.hostedLogout();
                ucState.loggedIn = false;
                ucState.user = null;
                ucState.tokens = [];
                ucState.lastUsername = '';
                localStorage.removeItem('uc_last_username');
                await window.api.hostedSaveConfig({ enabled: false, apiKey: '', username: '' });
                showNotLoggedIn();
                showToast('å·²é€€å‡ºç™»å½•');
            } catch (e) { showToast('é€€å‡ºå¤±è´¥: ' + e.message); }
        }

        async function loadTokens() {
            try {
                const result = await window.api.hostedGetTokens(1, 50);
                if (result.success && result.data && result.data.data) {
                    ucState.tokens = result.data.data.items || [];
                    renderTokens();
                }
            } catch (e) { console.error('Failed to load tokens:', e); }
        }

        function renderTokens() {
            const container = el('uc-tokens-list');
            const select = el('uc-token-select');
            if (!ucState.tokens || ucState.tokens.length === 0) {
                container.innerHTML = '<p class="text-muted">æš‚æ—  Token</p>';
                select.innerHTML = '<option value="">-- è¯·å…ˆåˆ›å»º Token --</option>';
                return;
            }
            let html = '<table class="table"><thead><tr><th>åç§°</th><th>Key</th><th style="text-align:right;">æ“ä½œ</th></tr></thead><tbody>';
            ucState.tokens.forEach(function(t) {
                html += '<tr><td>' + (t.name || '-') + '</td><td><code style="font-size:12px;">' + (t.key ? t.key.slice(0,12) + '...' : '-') + '</code></td>';
                html += '<td class="table-actions"><button class="btn btn-ghost btn-sm" onclick="copyToken(\'' + t.key + '\')">å¤åˆ¶</button>';
                html += '<button class="btn btn-ghost btn-sm" onclick="deleteToken(' + t.id + ')" style="color:var(--danger);">åˆ é™¤</button></td></tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
            let opts = '<option value="">-- é€‰æ‹© Token --</option>';
            ucState.tokens.forEach(function(t) { opts += '<option value="' + t.key + '">' + (t.name || '-') + '</option>'; });
            select.innerHTML = opts;
            if (ucState.config && ucState.config.apiKey) select.value = ucState.config.apiKey;
        }

        async function createToken() {
            const name = el('new-token-name').value.trim();
            if (!name) { showToast('è¯·è¾“å…¥åç§°'); return; }
            try {
                const result = await window.api.hostedCreateToken(name, 500000, false, -1);
                if (result.success) { showToast('åˆ›å»ºæˆåŠŸ'); el('new-token-name').value = ''; await loadTokens(); }
                else { showToast('åˆ›å»ºå¤±è´¥: ' + result.error); }
            } catch (e) { showToast('åˆ›å»ºå¤±è´¥: ' + e.message); }
        }

        async function deleteToken(id) {
            if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
            try {
                const result = await window.api.hostedDeleteToken(id);
                if (result.success) { showToast('å·²åˆ é™¤'); await loadTokens(); }
                else { showToast('åˆ é™¤å¤±è´¥: ' + result.error); }
            } catch (e) { showToast('åˆ é™¤å¤±è´¥: ' + e.message); }
        }

        function copyToken(key) {
            navigator.clipboard.writeText(key).then(function() { showToast('å·²å¤åˆ¶'); }).catch(function() { showToast('å¤åˆ¶å¤±è´¥'); });
        }

        function updatePlanSelection() {
            ['free', 'pro', 'ultimate'].forEach(function(p) {
                var card = el('plan-' + p);
                if (card) card.classList.toggle('selected', p === ucState.selectedPlan);
            });
        }

        async function applyConfig() {
            const apiKey = el('uc-token-select').value;
            if (!apiKey) { showToast('è¯·é€‰æ‹© Token'); return; }
            try {
                const result = await window.api.hostedApplyConfig(apiKey, ucState.selectedPlan);
                if (result.success) {
                    showToast('é…ç½®å·²åº”ç”¨');
                    ucState.config = Object.assign({}, ucState.config, { apiKey: apiKey, plan: ucState.selectedPlan, enabled: true });
                    updateConfigStatus();
                } else { showToast('åº”ç”¨å¤±è´¥: ' + result.error); }
            } catch (e) { showToast('åº”ç”¨å¤±è´¥: ' + e.message); }
        }

        async function removeConfig() {
            if (!confirm('ç¡®å®šç§»é™¤é…ç½®ï¼Ÿ')) return;
            try {
                const result = await window.api.hostedRemoveConfig();
                if (result.success) {
                    showToast('å·²ç§»é™¤');
                    ucState.config = Object.assign({}, ucState.config, { enabled: false, apiKey: '' });
                    updateConfigStatus();
                } else { showToast('ç§»é™¤å¤±è´¥: ' + result.error); }
            } catch (e) { showToast('ç§»é™¤å¤±è´¥: ' + e.message); }
        }

        function updateConfigStatus() {
            var statusEl = el('uc-config-status');
            if (!statusEl) return;
            var plans = { free: 'å…è´¹ç‰ˆ', pro: 'ä¸“ä¸šç‰ˆ', ultimate: 'æ——èˆ°ç‰ˆ' };
            if (ucState.config && ucState.config.enabled && ucState.config.apiKey) {
                statusEl.innerHTML = '<div style="padding:12px;background:rgba(34,197,94,0.1);border-radius:8px;color:#22c55e;"><strong>âœ“ å·²å¯ç”¨</strong> - ' + (plans[ucState.config.plan] || 'å…è´¹ç‰ˆ') + '</div>';
            } else {
                statusEl.innerHTML = '<div style="padding:12px;background:#E4E4E7;border-radius:8px;color:#A1A1AA;">æœªå¯ç”¨</div>';
            }
        }

        async function refreshLogs() {
            try {
                const result = await window.api.hostedGetUsageLogs(ucState.currentPage, ucState.pageSize);
                if (result.success && result.data && result.data.data) {
                    ucState.logs = result.data.data.items || [];
                    ucState.totalPages = Math.ceil((result.data.data.total || 0) / ucState.pageSize);
                    renderLogs();
                }
            } catch (e) { console.error('Failed to load logs:', e); }
        }

        function renderLogs() {
            var tbody = el('uc-logs-body');
            var pag = el('uc-logs-pagination');
            if (!ucState.logs || ucState.logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-muted" style="text-align:center;padding:24px;">æš‚æ— è®°å½•</td></tr>';
                pag.innerHTML = '';
                return;
            }
            tbody.innerHTML = ucState.logs.map(function(log) {
                var time = new Date(log.created_at * 1000).toLocaleString('zh-CN');
                var tokens = ((log.prompt_tokens || 0) + (log.completion_tokens || 0)).toLocaleString();
                return '<tr><td style="font-size:12px;color:#A1A1AA;">' + time + '</td><td><code style="font-size:12px;">' + (log.model_name || log.model || '-') + '</code></td><td>' + tokens + '</td><td>$' + ((log.quota || 0) / 500000).toFixed(4) + '</td></tr>';
            }).join('');
            if (ucState.totalPages > 1) {
                var h = '';
                if (ucState.currentPage > 1) h += '<button class="btn btn-ghost btn-sm" onclick="goToPage(' + (ucState.currentPage - 1) + ')">ä¸Šä¸€é¡µ</button>';
                h += '<span style="padding:0 12px;color:#A1A1AA;">' + ucState.currentPage + '/' + ucState.totalPages + '</span>';
                if (ucState.currentPage < ucState.totalPages) h += '<button class="btn btn-ghost btn-sm" onclick="goToPage(' + (ucState.currentPage + 1) + ')">ä¸‹ä¸€é¡µ</button>';
                pag.innerHTML = h;
            } else { pag.innerHTML = ''; }
        }

        function goToPage(p) { ucState.currentPage = p; refreshLogs(); }

        async function redeemCode() {
            var input = el('redeem-code-input');
            var code = input.value.trim();
            if (!code) { showToast('è¯·è¾“å…¥å…‘æ¢ç '); return; }
            try {
                const result = await window.api.hostedRedeemCode(code);
                if (result.success && result.data && result.data.success) {
                    showToast('å…‘æ¢æˆåŠŸï¼$' + ((result.data.data || 0) / 500000).toFixed(2));
                    input.value = '';
                    const userResult = await window.api.hostedGetCurrentUser();
                    if (userResult.success && userResult.data && userResult.data.data) {
                        ucState.user = userResult.data.data;
                        el('uc-balance').textContent = '$' + ((ucState.user.quota || 0) / 500000).toFixed(2);
                    }
                } else { showToast((result.data && result.data.message) || result.error || 'å…‘æ¢å¤±è´¥'); }
            } catch (e) { showToast('å…‘æ¢å¤±è´¥: ' + e.message); }
        }

        function copyAffCode() {
            var code = el('uc-aff-code').value;
            if (!code) { showToast('æš‚æ— é‚€è¯·ç '); return; }
            navigator.clipboard.writeText(code).then(function() { showToast('å·²å¤åˆ¶'); }).catch(function() { showToast('å¤åˆ¶å¤±è´¥'); });
        }

        function switchUcTab(tab) {
            ['overview', 'plan', 'keys'].forEach(function(t) {
                var tabEl = el('uc-tab-' + t);
                var panelEl = el('uc-panel-' + t);
                if (tabEl) tabEl.classList.toggle('active', t === tab);
                if (panelEl) panelEl.classList.toggle('hidden', t !== tab);
            });
            
            // åˆ‡æ¢æ—¶åŠ è½½å¯¹åº”æ•°æ®
            if (tab === 'overview') {
                refreshLogs();
                loadUsageChart();
            } else if (tab === 'keys') {
                loadTokens();
            }
        }

        function showBuyModal() {
            el('uc-modal-overlay').classList.remove('hidden');
            el('uc-modal-buy').classList.remove('hidden');
            el('uc-modal-redeem').classList.add('hidden');
            el('uc-modal-invite').classList.add('hidden');
        }

        function showRedeemModal() {
            el('uc-modal-overlay').classList.remove('hidden');
            el('uc-modal-buy').classList.add('hidden');
            el('uc-modal-redeem').classList.remove('hidden');
            el('uc-modal-invite').classList.add('hidden');
            el('redeem-code-input').value = '';
        }

        function showInviteModal() {
            el('uc-modal-overlay').classList.remove('hidden');
            el('uc-modal-buy').classList.add('hidden');
            el('uc-modal-redeem').classList.add('hidden');
            el('uc-modal-invite').classList.remove('hidden');
            var affCode = ucState.user ? ucState.user.aff_code : '';
            el('uc-invite-link').value = affCode ? 'http://8.153.201.122:3000/register?aff=' + affCode : '';
        }

        function closeUcModal(event) {
            if (event && event.target !== el('uc-modal-overlay')) return;
            el('uc-modal-overlay').classList.add('hidden');
        }

        function copyInviteLink() {
            var link = el('uc-invite-link').value;
            if (!link) { showToast('æš‚æ— é‚€è¯·é“¾æ¥'); return; }
            navigator.clipboard.writeText(link).then(function() { showToast('é‚€è¯·é“¾æ¥å·²å¤åˆ¶'); }).catch(function() { showToast('å¤åˆ¶å¤±è´¥'); });
        }

        function selectPlan(plan) {
            showToast('å¥—é¤åŠŸèƒ½æš‚æœªå¼€æ”¾');
            ucState.selectedPlan = plan;
            updatePlanSelection();
        }

        // --- Feishu Bot Logic ---
        
        async function loadFeishuConfig() {
            try {
                const result = await window.api.getFeishuConfig();
                if (result.success && result.data) {
                    el('feishu-app-id').value = result.data.app_id;
                    el('feishu-app-secret').value = result.data.app_secret;
                    el('feishu-working-dir').value = result.data.working_dir;
                    el('feishu-server-host').value = result.data.server_host;
                    el('feishu-server-port').value = result.data.server_port;
                    el('feishu-server-mode').checked = result.data.use_server_mode;
                }
                
                // Check status
                updateFeishuStatus();
            } catch (e) {
                console.error('Failed to load Feishu config:', e);
            }
        }
        
        async function saveFeishuConfig() {
            const config = {
                app_id: el('feishu-app-id').value,
                app_secret: el('feishu-app-secret').value,
                working_dir: el('feishu-working-dir').value,
                server_host: el('feishu-server-host').value,
                server_port: parseInt(el('feishu-server-port').value) || 4096,
                use_server_mode: el('feishu-server-mode').checked
            };
            
            const result = await window.api.saveFeishuConfig(config);
            if (result.success) {
                showToast('é£ä¹¦é…ç½®å·²ä¿å­˜');
            } else {
                showToast('ä¿å­˜å¤±è´¥: ' + result.error);
            }
        }
        
        async function startFeishuBot() {
            el('feishu-log-area').innerHTML = '<div class="text-muted">æ­£åœ¨å¯åŠ¨...</div>';
            const result = await window.api.startFeishuBot();
            if (result.success) {
                showToast('å¯åŠ¨æŒ‡ä»¤å·²å‘é€');
                updateFeishuStatus();
            } else {
                showToast('å¯åŠ¨å¤±è´¥: ' + result.error);
                el('feishu-log-area').innerHTML += `<div style="color: var(--danger)">å¯åŠ¨å¤±è´¥: ${result.error}</div>`;
            }
        }
        
        async function stopFeishuBot() {
            const result = await window.api.stopFeishuBot();
            if (result.success) {
                showToast('å·²åœæ­¢');
                updateFeishuStatus();
            } else {
                showToast('åœæ­¢å¤±è´¥: ' + result.error);
            }
        }
        
        async function updateFeishuStatus() {
            const result = await window.api.getFeishuBotStatus();
            const isRunning = result.success && result.data.running;
            
            const indicator = el('feishu-status-indicator');
            const startBtn = el('btn-start-feishu');
            const stopBtn = el('btn-stop-feishu');
            
            if (isRunning) {
                indicator.innerHTML = `
                    <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--success);"></div>
                    <span style="color: var(--success)">è¿è¡Œä¸­</span>
                `;
                startBtn.disabled = true;
                stopBtn.disabled = false;
            } else {
                indicator.innerHTML = `
                    <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--text-muted);"></div>
                    <span class="text-muted">æœªè¿è¡Œ</span>
                `;
                startBtn.disabled = false;
                stopBtn.disabled = true;
            }
        }
        
        // Listen for logs
        if (window.api.onFeishuBotLog) {
            window.api.onFeishuBotLog((log) => {
                const logArea = el('feishu-log-area');
                const div = document.createElement('div');
                div.textContent = log;
                logArea.appendChild(div);
                logArea.scrollTop = logArea.scrollHeight;
            });
        }
        
        if (window.api.onFeishuBotStatus) {
            window.api.onFeishuBotStatus((status) => {
                updateFeishuStatus();
                if (!status.running && status.code !== 0 && status.code !== null) {
                    const logArea = el('feishu-log-area');
                    const div = document.createElement('div');
                    div.style.color = 'var(--danger)';
                    div.textContent = `Process exited with code ${status.code}`;
                    logArea.appendChild(div);
                    logArea.scrollTop = logArea.scrollHeight;
                }
            });
        }

        // Start
        init();
        initUpdater();

    </script>
</body>
</html>
